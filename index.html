<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChroniCompanion - Your Daily Journey</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#5a6e5a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ChroniCompanion">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="shortcut icon" href="/icons/icon-192x192.png">
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        window.supabase = window.supabase.createClient(
            'https://wiriwyzrrbjmydbnjpei.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indpcml3eXpycmJqbXlkYm5qcGVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxNzk5MTYsImV4cCI6MjA2OTc1NTkxNn0.S_AaAv2jL4ZN-7zPF-J0a12drcrVNdU-MfFXS8h65fw',
            {
                auth: {
                    storageKey: 'supabase.auth.token',
                    autoRefreshToken: true,
                    persistSession: true,
                    detectSessionInUrl: true,
                    flowType: 'pkce'
                }
            }
        );
        console.log('‚úÖ Supabase client initialized');
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sage: {
                            50: '#f6f7f6',
                            100: '#e3e7e3',
                            200: '#c7d0c7',
                            300: '#a3b3a3',
                            400: '#7a8f7a',
                            500: '#5a6e5a',
                            600: '#485a48',
                            700: '#3c4a3c',
                            800: '#323d32',
                            900: '#2a332a'
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Chart.js for beautiful graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-sage-50 text-sage-900 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="mb-4">
                <i class="fas fa-seedling text-6xl text-sage-600"></i>
                        </div>
            <h1 class="text-3xl font-bold text-sage-800 mb-2">ChroniCompanion</h1>
            <p class="text-sage-600">Your Daily Journey</p>
                    </div>

        <!-- Authentication Section -->
            <div class="mb-6">
            <!-- Email Authentication Form (WORKING VERSION!) -->
            <div id="auth-form" class="max-w-sm mx-auto space-y-4">
                <div>
                    <label for="email-input" class="block text-sm font-medium text-sage-700 mb-1">Email</label>
                    <input type="email" 
                           id="email-input" 
                           placeholder="your@email.com"
                           class="w-full px-3 py-2 border border-sage-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sage-500 focus:border-transparent">
                </div>
                <div>
                    <label for="password-input" class="block text-sm font-medium text-sage-700 mb-1">Password</label>
                    <input type="password" 
                           id="password-input" 
                           placeholder="At least 6 characters"
                           class="w-full px-3 py-2 border border-sage-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sage-500 focus:border-transparent">
                </div>
                <button id="sign-in-btn" 
                        onclick="if(window.workingAuth && window.workingAuth.signInWithEmail) { window.workingAuth.signInWithEmail(); } else { console.error('‚ùå workingAuth not ready yet'); }"
                        class="w-full bg-sage-600 hover:bg-sage-700 text-white px-6 py-2 rounded-lg transition-colors duration-200 flex items-center justify-center">
                    <i class="fas fa-envelope mr-2"></i>Sign In / Create Account
                </button>
                <p class="text-xs text-sage-500 text-center">
                    Don't have an account? No worries - we'll create one for you!
                </p>
            </div>
            
            <!-- Signed In Controls -->
            <div id="signed-in-controls" class="max-w-sm mx-auto space-y-4" style="display: none;">
                <div class="text-center">
                    <div class="mb-4">
                        <i class="fas fa-user-circle text-4xl text-sage-600"></i>
                </div>
                    <p class="text-sage-700 mb-2">Signed in as:</p>
                    <p id="user-email" class="font-medium text-sage-800 mb-4"></p>
                    <button id="sign-out-btn" 
                            onclick="if(window.workingAuth && window.workingAuth.signOut) { window.workingAuth.signOut(); } else { console.error('‚ùå workingAuth not ready yet'); }"
                            class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition-colors duration-200">
                        Sign Out
                        </button>
                </div>
            </div>
        </div>

        <!-- App Content (Hidden until signed in) -->
        <div id="app-content" style="display: none;">
            <!-- Navigation Tabs -->
            <div class="flex mb-6 bg-white rounded-lg shadow-lg p-2">
                <button id="tab-entry" class="flex-1 py-2 px-4 rounded-lg bg-sage-600 text-white font-medium transition-colors">
                    <i class="fas fa-plus-circle mr-2"></i>New Entry
                        </button>
                <button id="tab-dashboard" class="flex-1 py-2 px-4 rounded-lg text-sage-600 hover:bg-sage-100 font-medium transition-colors ml-2">
                    <i class="fas fa-chart-line mr-2"></i>Dashboard
                            </button>
                <button id="tab-entries" class="flex-1 py-2 px-4 rounded-lg text-sage-600 hover:bg-sage-100 font-medium transition-colors ml-2">
                    <i class="fas fa-list mr-2"></i>All Entries
                            </button>
                        </div>
                        
            <!-- New Entry Tab -->
            <div id="content-entry" class="tab-content">
            <!-- New Entry Form -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex items-center mb-4">
                    <i class="fas fa-plus-circle text-2xl text-sage-600 mr-3"></i>
                    <h2 class="text-xl font-semibold text-sage-800">New Entry</h2>
                    </div>

                <form id="new-entry-form" class="space-y-4">
                    <!-- Date -->
                            <div>
                        <label for="entry-date" class="block text-sm font-medium text-sage-700 mb-1">Date</label>
                        <input type="date" 
                               id="entry-date" 
                               class="w-full px-3 py-2 border border-sage-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sage-500 focus:border-transparent">
                            </div>
                            
                    <!-- Mood Slider -->
                            <div>
                        <label for="mood-slider" class="block text-sm font-medium text-sage-700 mb-1">
                            Overall Mood: <span id="mood-value" class="font-semibold text-sage-600">5</span>/10
                        </label>
                        <input type="range" 
                               id="mood-slider" 
                               min="1" 
                               max="10" 
                               value="5"
                               class="w-full h-2 bg-sage-200 rounded-lg appearance-none cursor-pointer slider">
                        <div class="flex justify-between text-xs text-sage-500 mt-1">
                            <span>üò¢ Low</span>
                            <span>üòê Neutral</span>
                            <span>üòä High</span>
                        </div>
                    </div>

                    <!-- Energy Slider -->
                            <div>
                        <label for="energy-slider" class="block text-sm font-medium text-sage-700 mb-1">
                            Energy Level: <span id="energy-value" class="font-semibold text-sage-600">5</span>/10
                        </label>
                        <input type="range" 
                               id="energy-slider" 
                               min="1" 
                               max="10" 
                               value="5"
                               class="w-full h-2 bg-sage-200 rounded-lg appearance-none cursor-pointer slider">
                        <div class="flex justify-between text-xs text-sage-500 mt-1">
                            <span>‚ö° Low</span>
                            <span>üîã Moderate</span>
                            <span>üöÄ High</span>
                            </div>
                            </div>
                            
                    <!-- Pain Level Slider -->
                            <div>
                        <label for="pain-slider" class="block text-sm font-medium text-sage-700 mb-1">
                            Pain Level: <span id="pain-value" class="font-semibold text-sage-600">0</span>/10
                        </label>
                        <input type="range" 
                               id="pain-slider" 
                               min="0" 
                               max="10" 
                               value="0"
                               class="w-full h-2 bg-sage-200 rounded-lg appearance-none cursor-pointer slider">
                        <div class="flex justify-between text-xs text-sage-500 mt-1">
                            <span>üòå None</span>
                            <span>üòê Moderate</span>
                            <span>üò£ Severe</span>
                        </div>
                    </div>

                    <!-- Sleep Quality -->
                                <div>
                        <label for="sleep-slider" class="block text-sm font-medium text-sage-700 mb-1">
                            Sleep Quality: <span id="sleep-value" class="font-semibold text-sage-600">5</span>/10
                        </label>
                        <input type="range" 
                               id="sleep-slider" 
                               min="1" 
                               max="10" 
                               value="5"
                               class="w-full h-2 bg-sage-200 rounded-lg appearance-none cursor-pointer slider">
                        <div class="flex justify-between text-xs text-sage-500 mt-1">
                            <span>üò¥ Poor</span>
                            <span>üòê Average</span>
                            <span>üòä Excellent</span>
                                    </div>
                                </div>
                                
                    <!-- Symptoms -->
                                <div>
                        <label class="block text-sm font-medium text-sage-700 mb-2">Symptoms (check all that apply)</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="symptom-headache" class="mr-2 text-sage-600">
                                <span class="text-sm">ü§ï Headache</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="symptom-fatigue" class="mr-2 text-sage-600">
                                <span class="text-sm">üò¥ Fatigue</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="symptom-nausea" class="mr-2 text-sage-600">
                                <span class="text-sm">ü§¢ Nausea</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="symptom-dizziness" class="mr-2 text-sage-600">
                                <span class="text-sm">üí´ Dizziness</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="symptom-anxiety" class="mr-2 text-sage-600">
                                <span class="text-sm">üò∞ Anxiety</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="symptom-brain-fog" class="mr-2 text-sage-600">
                                <span class="text-sm">üß† Brain Fog</span>
                            </label>
                                    </div>
                                </div>
                                
                    <!-- Medications -->
                                <div>
                        <label for="medications" class="block text-sm font-medium text-sage-700 mb-1">Medications Taken</label>
                        <textarea id="medications" 
                                  rows="2"
                                  placeholder="List any medications, supplements, or treatments..."
                                  class="w-full px-3 py-2 border border-sage-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sage-500 focus:border-transparent resize-none"></textarea>
                        </div>

                    <!-- Activities -->
                                <div>
                        <label for="activities" class="block text-sm font-medium text-sage-700 mb-1">Activities & Exercise</label>
                        <textarea id="activities" 
                                  rows="2"
                                  placeholder="What activities did you do today? Exercise, work, hobbies..."
                                  class="w-full px-3 py-2 border border-sage-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sage-500 focus:border-transparent resize-none"></textarea>
                                </div>
                                
                    <!-- Weather -->
                                <div>
                        <label for="weather" class="block text-sm font-medium text-sage-700 mb-1">Weather/Environment</label>
                        <select id="weather" class="w-full px-3 py-2 border border-sage-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sage-500 focus:border-transparent">
                            <option value="">Select weather...</option>
                            <option value="sunny">‚òÄÔ∏è Sunny</option>
                            <option value="cloudy">‚òÅÔ∏è Cloudy</option>
                            <option value="rainy">üåßÔ∏è Rainy</option>
                            <option value="stormy">‚õàÔ∏è Stormy</option>
                            <option value="snowy">‚ùÑÔ∏è Snowy</option>
                            <option value="windy">üí® Windy</option>
                            <option value="humid">üíß Humid</option>
                            <option value="cold">ü•∂ Cold</option>
                            <option value="hot">ü•µ Hot</option>
                        </select>
                                </div>
                                
                    <!-- Notes -->
                                <div>
                        <label for="entry-notes" class="block text-sm font-medium text-sage-700 mb-1">Additional Notes</label>
                        <textarea id="entry-notes" 
                                  rows="4"
                                  placeholder="How are you feeling today? Any thoughts, patterns, or observations..."
                                  class="w-full px-3 py-2 border border-sage-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sage-500 focus:border-transparent resize-none"></textarea>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" 
                            class="w-full bg-sage-600 hover:bg-sage-700 text-white px-6 py-3 rounded-lg transition-colors duration-200 flex items-center justify-center">
                            <i class="fas fa-save mr-2"></i>Save Entry
                        </button>
                </form>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="content-dashboard" class="tab-content" style="display: none;">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Quick Stats -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-sage-800 mb-4">
                            <i class="fas fa-chart-bar mr-2"></i>Quick Stats
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-sage-600" id="total-entries">0</div>
                                <div class="text-sm text-sage-500">Total Entries</div>
                        </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600" id="avg-mood">0</div>
                                <div class="text-sm text-sage-500">Avg Mood</div>
                        </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600" id="avg-energy">0</div>
                                <div class="text-sm text-sage-500">Avg Energy</div>
                    </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-red-600" id="avg-pain">0</div>
                                <div class="text-sm text-sage-500">Avg Pain</div>
                </div>
                    </div>
                </div>

                    <!-- Recent Trends -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-sage-800 mb-4">
                            <i class="fas fa-trending-up mr-2"></i>Recent Trends
                        </h3>
                                                <div id="trends-chart" class="h-48">
                            <canvas id="trendsCanvas" width="400" height="200"></canvas>
                        </div>
                        </div>
                    </div>

                                <!-- Export Section -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-sage-800 mb-4">
                        <i class="fas fa-download mr-2"></i>Export Your Data
                    </h3>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="exportToCSV()" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center">
                            <i class="fas fa-file-csv mr-2"></i>Export to CSV
                        </button>
                        <button onclick="exportToJSON()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center">
                            <i class="fas fa-file-code mr-2"></i>Export to JSON
                        </button>
                        <button onclick="printReport()" 
                                class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center">
                            <i class="fas fa-print mr-2"></i>Print Report
                        </button>
                    </div>
                </div>
                
                <!-- Recent Entries Summary -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-sage-800 mb-4">
                        <i class="fas fa-history mr-2"></i>Recent Entries
                    </h3>
                    <div id="recent-entries" class="space-y-3">
                        <!-- Recent entries will be loaded here -->
                    </div>
                </div>
                    </div>

            <!-- All Entries Tab -->
            <div id="content-entries" class="tab-content" style="display: none;">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-sage-800 mb-4">
                        <i class="fas fa-list mr-2"></i>All Your Entries
                    </h3>
                    <div id="all-entries-list" class="space-y-4">
                        <!-- All entries will be loaded here -->
                            </div>
                            </div>
                        </div>
                    </div>
                </div>

    <!-- Working Authentication Script -->
    <script src="js/working-auth.js?v=NUCLEAR-RAILWAY-CACHE-CLEAR-v20000-1754439163"></script>
    
    <!-- App Functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Enter Key Support for Authentication
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            
            const handleEnterKey = (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    window.workingAuth?.signInWithEmail();
                }
            };
            
            if (emailInput) emailInput.addEventListener('keypress', handleEnterKey);
            if (passwordInput) passwordInput.addEventListener('keypress', handleEnterKey);
            
            // Slider Functionality
            const sliders = [
                { slider: 'mood-slider', value: 'mood-value' },
                { slider: 'energy-slider', value: 'energy-value' },
                { slider: 'pain-slider', value: 'pain-value' },
                { slider: 'sleep-slider', value: 'sleep-value' }
            ];
            
            sliders.forEach(({ slider, value }) => {
                const sliderEl = document.getElementById(slider);
                const valueEl = document.getElementById(value);
                
                if (sliderEl && valueEl) {
                    sliderEl.addEventListener('input', (e) => {
                        valueEl.textContent = e.target.value;
                    });
                }
            });
            
            // Set today's date as default
            const entryDate = document.getElementById('entry-date');
            if (entryDate) {
                const today = new Date().toISOString().split('T')[0];
                entryDate.value = today;
            }
            
            // New Entry Form Submission
            const newEntryForm = document.getElementById('new-entry-form');
            if (newEntryForm) {
                newEntryForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    saveNewEntry();
                });
            }
            
            // Tab Navigation
            const tabButtons = document.querySelectorAll('[id^="tab-"]');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.id.replace('tab-', '');
                    switchTab(tabName);
                });
            });
            
            console.log('‚úÖ App functionality initialized');
        });
        
        // Save New Entry Function
        function saveNewEntry() {
            const date = document.getElementById('entry-date').value;
            const mood = document.getElementById('mood-slider').value;
            const energy = document.getElementById('energy-slider').value;
            const pain = document.getElementById('pain-slider').value;
            const sleep = document.getElementById('sleep-slider').value;
            const notes = document.getElementById('entry-notes').value;
            const medications = document.getElementById('medications').value;
            const activities = document.getElementById('activities').value;
            const weather = document.getElementById('weather').value;
            
            // Get checked symptoms
            const symptoms = [];
            const symptomIds = ['headache', 'fatigue', 'nausea', 'dizziness', 'anxiety', 'brain-fog'];
            symptomIds.forEach(symptom => {
                const checkbox = document.getElementById(`symptom-${symptom}`);
                if (checkbox && checkbox.checked) {
                    symptoms.push(symptom);
                }
            });
            
            if (!date) {
                alert('Please select a date for your entry.');
                return;
            }
            
            const entry = {
                id: Date.now(), // Simple ID for now
                date: date,
                mood: parseInt(mood),
                energy: parseInt(energy),
                pain: parseInt(pain),
                sleep: parseInt(sleep),
                symptoms: symptoms,
                medications: medications.trim(),
                activities: activities.trim(),
                weather: weather,
                notes: notes.trim(),
                created_at: new Date().toISOString()
            };
            
            console.log('üíæ Saving entry:', entry);
            
            // For now, just save to localStorage (we'll add Supabase storage later)
            let entries = JSON.parse(localStorage.getItem('chronicompanion_entries') || '[]');
            entries.unshift(entry); // Add to beginning of array
            localStorage.setItem('chronicompanion_entries', JSON.stringify(entries));
            
            // Show success message
            alert('‚úÖ Entry saved successfully!');
            
            // Reset form
            document.getElementById('new-entry-form').reset();
            document.getElementById('entry-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('mood-value').textContent = '5';
            document.getElementById('energy-value').textContent = '5';
            document.getElementById('pain-value').textContent = '0';
            document.getElementById('sleep-value').textContent = '5';
            
            // Refresh entries list and dashboard
            loadEntries();
            updateDashboard();
            
            // Update chart after saving
            setTimeout(() => {
                createTrendsChart();
            }, 100);
        }
        
        // Load and display entries
        function loadEntries() {
            const entriesList = document.getElementById('entries-list');
            if (!entriesList) return;
            
            const entries = JSON.parse(localStorage.getItem('chronicompanion_entries') || '[]');
            
            if (entries.length === 0) {
                entriesList.innerHTML = `
                    <div class="text-center py-8 text-sage-500">
                        <i class="fas fa-journal-whills text-4xl mb-4"></i>
                        <p>No entries yet. Create your first entry above!</p>
                            </div>
                `;
                return;
            }
            
            entriesList.innerHTML = entries.map(entry => `
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-sage-500">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-semibold text-sage-800">${new Date(entry.date).toLocaleDateString()}</h3>
                        <div class="text-sm text-sage-500">
                            ${new Date(entry.created_at).toLocaleTimeString()}
                            </div>
                        </div>

                    <!-- Main metrics -->
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div class="flex items-center">
                            <span class="text-sm text-sage-600 mr-2">Mood:</span>
                            <div class="flex items-center">
                                <span class="font-semibold text-sage-800">${entry.mood}/10</span>
                                <div class="ml-2 text-lg">${getMoodEmoji(entry.mood)}</div>
                            </div>
                            </div>
                        <div class="flex items-center">
                            <span class="text-sm text-sage-600 mr-2">Energy:</span>
                            <div class="flex items-center">
                                <span class="font-semibold text-sage-800">${entry.energy}/10</span>
                                <div class="ml-2 text-lg">${getEnergyEmoji(entry.energy)}</div>
                        </div>
                    </div>
                        ${entry.pain !== undefined ? `
                        <div class="flex items-center">
                            <span class="text-sm text-sage-600 mr-2">Pain:</span>
                            <div class="flex items-center">
                                <span class="font-semibold text-sage-800">${entry.pain}/10</span>
                                <div class="ml-2 text-lg">${getPainEmoji(entry.pain)}</div>
                            </div>
                            </div>
                        ` : ''}
                        ${entry.sleep !== undefined ? `
                        <div class="flex items-center">
                            <span class="text-sm text-sage-600 mr-2">Sleep:</span>
                            <div class="flex items-center">
                                <span class="font-semibold text-sage-800">${entry.sleep}/10</span>
                                <div class="ml-2 text-lg">${getSleepEmoji(entry.sleep)}</div>
                        </div>
                        </div>
                        ` : ''}
                    </div>

                    <!-- Symptoms -->
                    ${entry.symptoms && entry.symptoms.length > 0 ? `
                    <div class="mb-3">
                        <span class="text-sm text-sage-600 font-medium">Symptoms:</span>
                        <div class="flex flex-wrap gap-1 mt-1">
                            ${entry.symptoms.map(symptom => `
                                <span class="inline-block bg-red-100 text-red-800 text-xs px-2 py-1 rounded">
                                    ${getSymptomDisplay(symptom)}
                                </span>
                            `).join('')}
                        </div>
                        </div>
                    ` : ''}
                    
                    <!-- Weather -->
                    ${entry.weather ? `
                    <div class="mb-3">
                        <span class="text-sm text-sage-600 mr-2">Weather:</span>
                        <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">
                            ${getWeatherDisplay(entry.weather)}
                        </span>
                    </div>
                    ` : ''}
                    
                    <!-- Medications -->
                    ${entry.medications ? `
                    <div class="mb-3">
                        <span class="text-sm text-sage-600 font-medium">Medications:</span>
                        <p class="text-sage-700 text-sm bg-green-50 p-2 rounded mt-1">${entry.medications}</p>
    </div>
                    ` : ''}
                    
                    <!-- Activities -->
                    ${entry.activities ? `
                    <div class="mb-3">
                        <span class="text-sm text-sage-600 font-medium">Activities:</span>
                        <p class="text-sage-700 text-sm bg-purple-50 p-2 rounded mt-1">${entry.activities}</p>
    </div>
                    ` : ''}
                    
                    <!-- Notes -->
                    ${entry.notes ? `
                    <div class="mb-3">
                        <span class="text-sm text-sage-600 font-medium">Notes:</span>
                        <p class="text-sage-700 text-sm bg-sage-50 p-2 rounded mt-1">${entry.notes}</p>
            </div>
                    ` : ''}
            </div>
            `).join('');
        }
        
        // Helper functions for emojis
        function getMoodEmoji(mood) {
            if (mood <= 3) return 'üò¢';
            if (mood <= 5) return 'üòê';
            if (mood <= 7) return 'üôÇ';
            return 'üòä';
        }
        
        function getEnergyEmoji(energy) {
            if (energy <= 3) return '‚ö°';
            if (energy <= 7) return 'üîã';
            return 'üöÄ';
        }
        
        function getPainEmoji(pain) {
            if (pain === 0) return 'üòå';
            if (pain <= 3) return 'üòê';
            if (pain <= 6) return 'üò£';
            return 'üòñ';
        }
        
        function getSleepEmoji(sleep) {
            if (sleep <= 3) return 'üò¥';
            if (sleep <= 7) return 'üòê';
            return 'üòä';
        }
        
        function getSymptomDisplay(symptom) {
            const symptoms = {
                'headache': 'ü§ï Headache',
                'fatigue': 'üò¥ Fatigue',
                'nausea': 'ü§¢ Nausea',
                'dizziness': 'üí´ Dizziness',
                'anxiety': 'üò∞ Anxiety',
                'brain-fog': 'üß† Brain Fog'
            };
            return symptoms[symptom] || symptom;
        }
        
        function getWeatherDisplay(weather) {
            const weatherOptions = {
                'sunny': '‚òÄÔ∏è Sunny',
                'cloudy': '‚òÅÔ∏è Cloudy',
                'rainy': 'üåßÔ∏è Rainy',
                'stormy': '‚õàÔ∏è Stormy',
                'snowy': '‚ùÑÔ∏è Snowy',
                'windy': 'üí® Windy',
                'humid': 'üíß Humid',
                'cold': 'ü•∂ Cold',
                'hot': 'ü•µ Hot'
            };
            return weatherOptions[weather] || weather;
        }
        
        // Tab Navigation
        function switchTab(tabName) {
            // Update button styles
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('bg-sage-600', 'text-white');
                btn.classList.add('text-sage-600', 'hover:bg-sage-100');
            });
            
            document.getElementById(`tab-${tabName}`).classList.add('bg-sage-600', 'text-white');
            document.getElementById(`tab-${tabName}`).classList.remove('text-sage-600', 'hover:bg-sage-100');
            
            // Show/hide content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            document.getElementById(`content-${tabName}`).style.display = 'block';
            
            // Load content based on tab
            if (tabName === 'dashboard') {
                updateDashboard();
                setTimeout(() => {
                    createTrendsChart();
                }, 100);
            } else if (tabName === 'entries') {
                loadAllEntries();
            }
        }
        
        // Update Dashboard
        function updateDashboard() {
            const entries = JSON.parse(localStorage.getItem('chronicompanion_entries') || '[]');
            
            // Quick Stats
            document.getElementById('total-entries').textContent = entries.length;
            
            if (entries.length > 0) {
                const avgMood = (entries.reduce((sum, entry) => sum + (entry.mood || 0), 0) / entries.length).toFixed(1);
                const avgEnergy = (entries.reduce((sum, entry) => sum + (entry.energy || 0), 0) / entries.length).toFixed(1);
                const avgPain = (entries.reduce((sum, entry) => sum + (entry.pain || 0), 0) / entries.length).toFixed(1);
                
                document.getElementById('avg-mood').textContent = avgMood;
                document.getElementById('avg-energy').textContent = avgEnergy;
                document.getElementById('avg-pain').textContent = avgPain;
            }
            
            // Recent Entries (last 5)
            const recentEntries = entries.slice(0, 5);
            const recentContainer = document.getElementById('recent-entries');
            
            if (recentEntries.length === 0) {
                recentContainer.innerHTML = '<p class="text-sage-500 text-center py-4">No entries yet. Create your first entry!</p>';
            } else {
                recentContainer.innerHTML = recentEntries.map(entry => `
                    <div class="flex justify-between items-center p-3 bg-sage-50 rounded-lg">
                        <div>
                            <div class="font-medium text-sage-800">${new Date(entry.date).toLocaleDateString()}</div>
                            <div class="text-sm text-sage-600">
                                Mood: ${entry.mood}/10 | Energy: ${entry.energy}/10 | Pain: ${entry.pain || 0}/10
                            </div>
                        </div>
                        <div class="text-lg">
                            ${getMoodEmoji(entry.mood)} ${getEnergyEmoji(entry.energy)}
                        </div>
                    </div>
                `).join('');
            }
        }
        
        // Load All Entries
        function loadAllEntries() {
            const entries = JSON.parse(localStorage.getItem('chronicompanion_entries') || '[]');
            const allEntriesContainer = document.getElementById('all-entries-list');
            
            if (entries.length === 0) {
                allEntriesContainer.innerHTML = `
                    <div class="text-center py-8 text-sage-500">
                        <i class="fas fa-journal-whills text-4xl mb-4"></i>
                        <p>No entries yet. Create your first entry!</p>
                    </div>
                `;
                return;
            }
            
            // Use the same display logic as the main entries list
            allEntriesContainer.innerHTML = entries.map(entry => `
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-sage-500">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-semibold text-sage-800">${new Date(entry.date).toLocaleDateString()}</h3>
                        <div class="text-sm text-sage-500">
                            ${new Date(entry.created_at).toLocaleTimeString()}
                        </div>
                    </div>
                    
                    <!-- Main metrics -->
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div class="flex items-center">
                            <span class="text-sm text-sage-600 mr-2">Mood:</span>
                            <div class="flex items-center">
                                <span class="font-semibold text-sage-800">${entry.mood}/10</span>
                                <div class="ml-2 text-lg">${getMoodEmoji(entry.mood)}</div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span class="text-sm text-sage-600 mr-2">Energy:</span>
                            <div class="flex items-center">
                                <span class="font-semibold text-sage-800">${entry.energy}/10</span>
                                <div class="ml-2 text-lg">${getEnergyEmoji(entry.energy)}</div>
                            </div>
                        </div>
                        ${entry.pain !== undefined ? `
                        <div class="flex items-center">
                            <span class="text-sm text-sage-600 mr-2">Pain:</span>
                            <div class="flex items-center">
                                <span class="font-semibold text-sage-800">${entry.pain}/10</span>
                                <div class="ml-2 text-lg">${getPainEmoji(entry.pain)}</div>
                            </div>
                        </div>
                        ` : ''}
                        ${entry.sleep !== undefined ? `
                        <div class="flex items-center">
                            <span class="text-sm text-sage-600 mr-2">Sleep:</span>
                            <div class="flex items-center">
                                <span class="font-semibold text-sage-800">${entry.sleep}/10</span>
                                <div class="ml-2 text-lg">${getSleepEmoji(entry.sleep)}</div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Symptoms -->
                    ${entry.symptoms && entry.symptoms.length > 0 ? `
                    <div class="mb-3">
                        <span class="text-sm text-sage-600 font-medium">Symptoms:</span>
                        <div class="flex flex-wrap gap-1 mt-1">
                            ${entry.symptoms.map(symptom => `
                                <span class="inline-block bg-red-100 text-red-800 text-xs px-2 py-1 rounded">
                                    ${getSymptomDisplay(symptom)}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Weather -->
                    ${entry.weather ? `
                    <div class="mb-3">
                        <span class="text-sm text-sage-600 mr-2">Weather:</span>
                        <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">
                            ${getWeatherDisplay(entry.weather)}
                        </span>
                    </div>
                    ` : ''}
                    
                    <!-- Medications -->
                    ${entry.medications ? `
                    <div class="mb-3">
                        <span class="text-sm text-sage-600 font-medium">Medications:</span>
                        <p class="text-sage-700 text-sm bg-green-50 p-2 rounded mt-1">${entry.medications}</p>
                    </div>
                    ` : ''}
                    
                    <!-- Activities -->
                    ${entry.activities ? `
                    <div class="mb-3">
                        <span class="text-sm text-sage-600 font-medium">Activities:</span>
                        <p class="text-sage-700 text-sm bg-purple-50 p-2 rounded mt-1">${entry.activities}</p>
                    </div>
                    ` : ''}
                    
                    <!-- Notes -->
                    ${entry.notes ? `
                    <div class="mb-3">
                        <span class="text-sm text-sage-600 font-medium">Notes:</span>
                        <p class="text-sage-700 text-sm bg-sage-50 p-2 rounded mt-1">${entry.notes}</p>
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        // Global chart variable to track existing chart
        let trendsChart = null;
        
        // Create Trends Chart
        function createTrendsChart() {
            const entries = JSON.parse(localStorage.getItem('chronicompanion_entries') || '[]');
            const canvas = document.getElementById('trendsCanvas');
            
            if (!canvas) {
                console.log('Canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (trendsChart) {
                trendsChart.destroy();
            }
            
            if (entries.length === 0) {
                // Show "no data" message
                ctx.fillStyle = '#9CA3AF';
                ctx.font = '16px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No entries yet - create your first entry!', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Sort entries by date
            entries.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Prepare data
            const labels = entries.map(entry => {
                const date = new Date(entry.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            const moodData = entries.map(entry => entry.mood || null);
            const energyData = entries.map(entry => entry.energy || null);
            const painData = entries.map(entry => entry.pain || null);
            
            // Create the chart
            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Mood',
                            data: moodData,
                            borderColor: '#5a6e5a',
                            backgroundColor: 'rgba(90, 110, 90, 0.1)',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Energy',
                            data: energyData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Pain',
                            data: painData,
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Rating (0-10)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Health Trends Over Time'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
        
        // Export Functions
        function exportToCSV() {
            const entries = JSON.parse(localStorage.getItem('chronicompanion_entries') || '[]');
            
            if (entries.length === 0) {
                alert('No entries to export!');
                return;
            }
            
            // CSV headers
            const headers = ['Date', 'Mood', 'Energy', 'Pain', 'Sleep', 'Symptoms', 'Medications', 'Activities', 'Weather', 'Notes'];
            
            // Convert entries to CSV format
            const csvData = entries.map(entry => {
                return [
                    entry.date || '',
                    entry.mood || '',
                    entry.energy || '',
                    entry.pain || '',
                    entry.sleep || '',
                    (entry.symptoms || []).join('; '),
                    entry.medications || '',
                    entry.activities || '',
                    entry.weather || '',
                    entry.notes || ''
                ].map(field => `"${field}"`).join(',');
            });
            
            // Combine headers and data
            const csv = [headers.join(','), ...csvData].join('\n');
            
            // Create and download file
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chronicompanion-entries-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            console.log('‚úÖ CSV export completed');
        }
        
        function exportToJSON() {
            const entries = JSON.parse(localStorage.getItem('chronicompanion_entries') || '[]');
            
            if (entries.length === 0) {
                alert('No entries to export!');
                return;
            }
            
            // Create export object with metadata
            const exportData = {
                exported_at: new Date().toISOString(),
                app_version: 'ChroniCompanion v1.3',
                total_entries: entries.length,
                entries: entries
            };
            
            // Create and download file
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chronicompanion-entries-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            console.log('‚úÖ JSON export completed');
        }
        
        function printReport() {
            const entries = JSON.parse(localStorage.getItem('chronicompanion_entries') || '[]');
            
            if (entries.length === 0) {
                alert('No entries to print!');
                return;
            }
            
            // Calculate statistics
            const totalEntries = entries.length;
            const avgMood = entries.length > 0 ? (entries.reduce((sum, entry) => sum + (entry.mood || 0), 0) / entries.length).toFixed(1) : 'N/A';
            const avgEnergy = entries.length > 0 ? (entries.reduce((sum, entry) => sum + (entry.energy || 0), 0) / entries.length).toFixed(1) : 'N/A';
            const avgPain = entries.length > 0 ? (entries.reduce((sum, entry) => sum + (entry.pain || 0), 0) / entries.length).toFixed(1) : 'N/A';
            
            // Create printable HTML
            const printContent = `
                <html>
                <head>
                    <title>ChroniCompanion Health Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #5a6e5a; padding-bottom: 20px; }
                        .stats { display: flex; justify-content: space-around; margin: 20px 0; }
                        .stat-box { text-align: center; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
                        .entry { margin: 20px 0; padding: 15px; border: 1px solid #eee; border-left: 4px solid #5a6e5a; }
                        .entry-date { font-weight: bold; color: #5a6e5a; margin-bottom: 10px; }
                        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 10px 0; }
                        .metric { padding: 5px; background: #f9f9f9; border-radius: 3px; }
                        .notes { margin-top: 10px; padding: 10px; background: #f6f7f6; border-radius: 5px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üå± ChroniCompanion Health Report</h1>
                        <p>Generated on ${new Date().toLocaleDateString()}</p>
                        <p>Total Entries: ${totalEntries}</p>
                    </div>
                    
                    <div class="stats">
                        <div class="stat-box">
                            <h3>Average Mood</h3>
                            <p>${avgMood}/10</p>
                        </div>
                        <div class="stat-box">
                            <h3>Average Energy</h3>
                            <p>${avgEnergy}/10</p>
                        </div>
                        <div class="stat-box">
                            <h3>Average Pain</h3>
                            <p>${avgPain}/10</p>
                        </div>
                    </div>
                    
                    <h2>Recent Entries</h2>
                    ${entries.slice(0, 10).map(entry => `
                        <div class="entry">
                            <div class="entry-date">${new Date(entry.date).toLocaleDateString()}</div>
                            <div class="metrics">
                                <div class="metric">Mood: ${entry.mood}/10 ${getMoodEmoji(entry.mood)}</div>
                                <div class="metric">Energy: ${entry.energy}/10 ${getEnergyEmoji(entry.energy)}</div>
                                ${entry.pain !== undefined ? `<div class="metric">Pain: ${entry.pain}/10 ${getPainEmoji(entry.pain)}</div>` : ''}
                                ${entry.sleep !== undefined ? `<div class="metric">Sleep: ${entry.sleep}/10 ${getSleepEmoji(entry.sleep)}</div>` : ''}
                            </div>
                            ${entry.symptoms && entry.symptoms.length > 0 ? `<div><strong>Symptoms:</strong> ${entry.symptoms.join(', ')}</div>` : ''}
                            ${entry.medications ? `<div><strong>Medications:</strong> ${entry.medications}</div>` : ''}
                            ${entry.activities ? `<div><strong>Activities:</strong> ${entry.activities}</div>` : ''}
                            ${entry.weather ? `<div><strong>Weather:</strong> ${entry.weather}</div>` : ''}
                            ${entry.notes ? `<div class="notes"><strong>Notes:</strong> ${entry.notes}</div>` : ''}
                        </div>
                    `).join('')}
                </body>
                </html>
            `;
            
            // Open print dialog
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
            
            console.log('‚úÖ Print report opened');
        }
    </script>
</body>
</html> 