<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChroniCompanion - Your Daily Journey</title>
    
    <!-- PWA Manifest REMOVED to prevent duplicate app installation -->
    <!-- <link rel="manifest" href="/manifest.json"> -->
    <meta name="theme-color" content="#5a6e5a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ChroniCompanion">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="shortcut icon" href="/icons/icon-192x192.png">
    
    <!-- Mobile Storage Implementation -->
    <script src="js/mobile-storage.js"></script>
    
    <!-- AI Health Coach -->
    <script src="js/ai-coach-secure.js"></script>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Stripe Checkout -->
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // Initialize Supabase with proper mobile storage
        async function initializeSupabase() {
            // Check if we're running in Capacitor mobile app (not mobile browser)
            const isCapacitorMobile = window.Capacitor && window.Capacitor.getPlatform() !== 'web';
            console.log('üîç Platform detection:', {
                hasCapacitor: !!window.Capacitor,
                platform: window.Capacitor?.getPlatform?.(),
                isCapacitorMobile: isCapacitorMobile,
                userAgent: navigator.userAgent
            });
            
            // Wait for mobile storage to be ready (only for Capacitor apps)
            if (isCapacitorMobile && window.mobileStorage) {
                // Test storage health before using it
                console.log('üîç MOBILE DEBUG: Testing storage health...');
                const storageHealthy = await window.mobileStorage.checkStorageHealth();
                console.log('üîç MOBILE DEBUG: Storage health result:', storageHealthy);
                if (!storageHealthy) {
                    console.error('‚ùå Mobile storage health check failed!');
                    // Try to fix storage issues
                    try {
                        await window.mobileStorage.clear();
                        console.log('üîß Cleared mobile storage, retesting...');
                        const retestResult = await window.mobileStorage.checkStorageHealth();
                        console.log('üîç MOBILE DEBUG: Storage retest result:', retestResult);
                    } catch (clearError) {
                        console.error('‚ùå Failed to clear mobile storage:', clearError);
                    }
                } else {
                    console.log('‚úÖ Mobile storage is healthy!');
                }
            } else {
                console.log('üîç PLATFORM DEBUG: isCapacitorMobile =', isCapacitorMobile, 'mobileStorage =', !!window.mobileStorage);
            }
            
            // Create Supabase client with proper storage
            const supabaseConfig = {
                auth: {
                    storageKey: 'supabase.auth.token',
                    autoRefreshToken: true,
                    persistSession: true,
                    detectSessionInUrl: !isCapacitorMobile, // Only Capacitor apps should NOT detect URL sessions
                    flowType: isCapacitorMobile ? 'pkce' : 'implicit' // CRITICAL: Capacitor apps need PKCE, browsers use implicit
                }
            };
            
            // Add mobile-aware storage if available (only for Capacitor apps)
            if (isCapacitorMobile && window.mobileStorage) {
                supabaseConfig.auth.storage = window.mobileStorage;
                console.log('‚úÖ Using Capacitor mobile storage');
            } else {
                console.log('‚úÖ Using standard browser storage');
            }
            
            window.supabase = window.supabase.createClient(
                'https://wiriwyzrrbjmydbnjpei.supabase.co',
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indpcml3eXpycmJqbXlkYm5qcGVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxNzk5MTYsImV4cCI6MjA2OTc1NTkxNn0.S_AaAv2jL4ZN-7zPF-J0a12drcrVNdU-MfFXS8h65fw',
                supabaseConfig
            );
            
            // Verify Supabase client is properly initialized
            if (!window.supabase || !window.supabase.auth) {
                console.error('‚ùå CRITICAL: Supabase client initialization failed!', {
                    supabaseExists: !!window.supabase,
                    authExists: !!window.supabase?.auth,
                    supabaseLib: !!window.supabase
                });
            } else {
                console.log('‚úÖ Supabase client initialized for', isCapacitorMobile ? 'Capacitor mobile app' : 'web browser', 'with', (isCapacitorMobile && window.mobileStorage) ? 'Capacitor storage' : 'browser storage');
                console.log('‚úÖ Supabase auth methods available:', {
                    signInWithPassword: !!window.supabase.auth.signInWithPassword,
                    signUp: !!window.supabase.auth.signUp,
                    signOut: !!window.supabase.auth.signOut
                });
            }
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeSupabase);
        } else {
            initializeSupabase();
        }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sage: {
                            50: '#f6f7f6',
                            100: '#e3e7e3',
                            200: '#c7d0c7',
                            300: '#a3b3a3',
                            400: '#7a8f7a',
                            500: '#5a6e5a',
                            600: '#485a48',
                            700: '#3c4a3c',
                            800: '#323d32',
                            900: '#2a332a'
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Chart.js for beautiful graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-sage-50 text-sage-900 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="mb-4">
                <i class="fas fa-seedling text-6xl text-sage-600"></i>
                        </div>
            <h1 class="text-3xl font-bold text-sage-800 mb-2">ChroniCompanion</h1>
            <p class="text-sage-600">Your Daily Journey</p>
                    </div>

        <!-- Authentication Section -->
            <div class="mb-6">
            <!-- Email Authentication Form (WORKING VERSION!) -->
            <div id="auth-form" class="max-w-sm mx-auto space-y-4">
                <div>
                    <label for="email-input" class="block text-sm font-medium text-sage-700 mb-1">Email</label>
                    <input type="email" 
                           id="email-input" 
                           placeholder="your@email.com"
                           class="w-full px-3 py-2 border border-sage-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sage-500 focus:border-transparent">
                </div>
                <div>
                    <label for="password-input" class="block text-sm font-medium text-sage-700 mb-1">Password</label>
                    <input type="password" 
                           id="password-input" 
                           placeholder="At least 6 characters"
                           class="w-full px-3 py-2 border border-sage-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sage-500 focus:border-transparent">
                </div>
                <button id="sign-in-btn" 
                        onclick="if(window.workingAuth && window.workingAuth.signInWithEmail) { window.workingAuth.signInWithEmail(); } else { console.error('‚ùå workingAuth not ready yet'); }"
                        class="w-full bg-sage-600 hover:bg-sage-700 text-white px-6 py-2 rounded-lg transition-colors duration-200 flex items-center justify-center">
                    <i class="fas fa-envelope mr-2"></i>Sign In / Create Account
                </button>
                <p class="text-xs text-sage-500 text-center">
                    Don't have an account? No worries - we'll create one for you!
                </p>
            </div>
            
            <!-- Signed In Controls -->
            <div id="signed-in-controls" class="max-w-sm mx-auto space-y-4" style="display: none;">
                <div class="text-center">
                    <div class="mb-4">
                        <i class="fas fa-user-circle text-4xl text-sage-600"></i>
                </div>
                    <p class="text-sage-700 mb-2">Signed in as:</p>
                    <p id="user-email" class="font-medium text-sage-800 mb-4"></p>
                    <button id="sign-out-btn" 
                            onclick="console.log('üîê Sign Out clicked!'); if(window.workingAuth && window.workingAuth.signOut) { console.log('‚úÖ Calling workingAuth.signOut()'); window.workingAuth.signOut(); } else { console.error('‚ùå workingAuth not ready yet', window.workingAuth); }"
                            class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition-colors duration-200">
                        Sign Out
                        </button>
                </div>
            </div>
        </div>

        <!-- App Content (Hidden until signed in) -->
        <div id="app-content" style="display: none;">
            <!-- Navigation Tabs -->
            <div class="flex mb-4 md:mb-6 bg-white rounded-lg shadow-lg p-2">
                <button id="tab-entry" class="flex-1 py-2 px-2 md:px-4 rounded-lg bg-sage-600 text-white font-medium transition-colors text-xs md:text-sm">
                    <i class="fas fa-plus-circle mr-1 md:mr-2"></i><span class="hidden sm:inline">New Entry</span><span class="sm:hidden">New</span>
                </button>
                <button id="tab-dashboard" class="flex-1 py-2 px-2 md:px-4 rounded-lg text-sage-600 hover:bg-sage-100 font-medium transition-colors ml-2 text-xs md:text-sm">
                    <i class="fas fa-chart-line mr-1 md:mr-2"></i><span class="hidden sm:inline">Dashboard</span><span class="sm:hidden">Stats</span>
                </button>
                <button id="tab-entries" class="flex-1 py-2 px-2 md:px-4 rounded-lg text-sage-600 hover:bg-sage-100 font-medium transition-colors ml-2 text-xs md:text-sm">
                    <i class="fas fa-list mr-1 md:mr-2"></i><span class="hidden sm:inline">All Entries</span><span class="sm:hidden">All</span>
                </button>
                <button id="tab-ai-coach" class="flex-1 py-2 px-2 md:px-4 rounded-lg text-sage-600 hover:bg-sage-100 font-medium transition-colors ml-2 text-xs md:text-sm">
                    <i class="fas fa-robot mr-1 md:mr-2"></i><span class="hidden sm:inline">AI Coach</span><span class="sm:hidden">AI</span>
                    <span id="ai-premium-badge" class="ml-1 text-xs bg-gradient-to-r from-purple-500 to-pink-500 text-white px-1 md:px-2 py-0.5 rounded-full">Premium</span>
                </button>
            </div>
                        
            <!-- New Entry Tab -->
            <div id="content-entry" class="tab-content">
            <!-- New Entry Form -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex items-center mb-4">
                    <i class="fas fa-plus-circle text-2xl text-sage-600 mr-3"></i>
                    <h2 class="text-xl font-semibold text-sage-800">New Entry</h2>
                    </div>

                <form id="new-entry-form" class="space-y-4">
                    <!-- Date -->
                            <div>
                        <label for="entry-date" class="block text-sm font-medium text-sage-700 mb-1">Date</label>
                        <input type="date" 
                               id="entry-date" 
                               class="w-full px-3 py-2 border border-sage-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sage-500 focus:border-transparent">
                            </div>
                            
                    <!-- Mood Slider -->
                            <div>
                        <label for="mood-slider" class="block text-sm font-medium text-sage-700 mb-1">
                            Overall Mood: <span id="mood-value" class="font-semibold text-sage-600">5</span>/10
                        </label>
                        <input type="range" 
                               id="mood-slider" 
                               min="1" 
                               max="10" 
                               value="5"
                               class="w-full h-2 bg-sage-200 rounded-lg appearance-none cursor-pointer slider">
                        <div class="flex justify-between text-xs text-sage-500 mt-1">
                            <span>üò¢ Low</span>
                            <span>üòê Neutral</span>
                            <span>üòä High</span>
                        </div>
                    </div>

                    <!-- Energy Slider -->
                            <div>
                        <label for="energy-slider" class="block text-sm font-medium text-sage-700 mb-1">
                            Energy Level: <span id="energy-value" class="font-semibold text-sage-600">5</span>/10
                        </label>
                        <input type="range" 
                               id="energy-slider" 
                               min="1" 
                               max="10" 
                               value="5"
                               class="w-full h-2 bg-sage-200 rounded-lg appearance-none cursor-pointer slider">
                        <div class="flex justify-between text-xs text-sage-500 mt-1">
                            <span>‚ö° Low</span>
                            <span>üîã Moderate</span>
                            <span>üöÄ High</span>
                            </div>
                            </div>
                            
                    <!-- Pain Level Slider -->
                            <div>
                        <label for="pain-slider" class="block text-sm font-medium text-sage-700 mb-1">
                            Pain Level: <span id="pain-value" class="font-semibold text-sage-600">0</span>/10
                        </label>
                        <input type="range" 
                               id="pain-slider" 
                               min="0" 
                               max="10" 
                               value="0"
                               class="w-full h-2 bg-sage-200 rounded-lg appearance-none cursor-pointer slider">
                        <div class="flex justify-between text-xs text-sage-500 mt-1">
                            <span>üòå None</span>
                            <span>üòê Moderate</span>
                            <span>üò£ Severe</span>
                        </div>
                    </div>

                    <!-- Sleep Quality -->
                                <div>
                        <label for="sleep-slider" class="block text-sm font-medium text-sage-700 mb-1">
                            Sleep Quality: <span id="sleep-value" class="font-semibold text-sage-600">5</span>/10
                        </label>
                        <input type="range" 
                               id="sleep-slider" 
                               min="1" 
                               max="10" 
                               value="5"
                               class="w-full h-2 bg-sage-200 rounded-lg appearance-none cursor-pointer slider">
                        <div class="flex justify-between text-xs text-sage-500 mt-1">
                            <span>üò¥ Poor</span>
                            <span>üòê Average</span>
                            <span>üòä Excellent</span>
                                    </div>
                                </div>
                                
                    <!-- Symptoms -->
                                <div>
                        <label class="block text-sm font-medium text-sage-700 mb-2">Symptoms (check all that apply)</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="symptom-headache" class="mr-2 text-sage-600">
                                <span class="text-sm">ü§ï Headache</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="symptom-fatigue" class="mr-2 text-sage-600">
                                <span class="text-sm">üò¥ Fatigue</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="symptom-nausea" class="mr-2 text-sage-600">
                                <span class="text-sm">ü§¢ Nausea</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="symptom-dizziness" class="mr-2 text-sage-600">
                                <span class="text-sm">üí´ Dizziness</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="symptom-anxiety" class="mr-2 text-sage-600">
                                <span class="text-sm">üò∞ Anxiety</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="symptom-brain-fog" class="mr-2 text-sage-600">
                                <span class="text-sm">üß† Brain Fog</span>
                            </label>
                                    </div>
                                </div>
                                
                    <!-- Medications -->
                                <div>
                        <label for="medications" class="block text-sm font-medium text-sage-700 mb-1">Medications Taken</label>
                        <textarea id="medications" 
                                  rows="2"
                                  placeholder="List any medications, supplements, or treatments..."
                                  class="w-full px-3 py-2 border border-sage-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sage-500 focus:border-transparent resize-none"></textarea>
                        </div>

                    <!-- Activities -->
                                <div>
                        <label for="activities" class="block text-sm font-medium text-sage-700 mb-1">Activities & Exercise</label>
                        <textarea id="activities" 
                                  rows="2"
                                  placeholder="What activities did you do today? Exercise, work, hobbies..."
                                  class="w-full px-3 py-2 border border-sage-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sage-500 focus:border-transparent resize-none"></textarea>
                                </div>
                                
                    <!-- Weather -->
                                <div>
                        <label for="weather" class="block text-sm font-medium text-sage-700 mb-1">Weather/Environment</label>
                        <select id="weather" class="w-full px-3 py-2 border border-sage-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sage-500 focus:border-transparent">
                            <option value="">Select weather...</option>
                            <option value="sunny">‚òÄÔ∏è Sunny</option>
                            <option value="cloudy">‚òÅÔ∏è Cloudy</option>
                            <option value="rainy">üåßÔ∏è Rainy</option>
                            <option value="stormy">‚õàÔ∏è Stormy</option>
                            <option value="snowy">‚ùÑÔ∏è Snowy</option>
                            <option value="windy">üí® Windy</option>
                            <option value="humid">üíß Humid</option>
                            <option value="cold">ü•∂ Cold</option>
                            <option value="hot">ü•µ Hot</option>
                        </select>
                                </div>
                                
                    <!-- Notes -->
                                <div>
                        <label for="entry-notes" class="block text-sm font-medium text-sage-700 mb-1">Additional Notes</label>
                        <textarea id="entry-notes" 
                                  rows="4"
                                  placeholder="How are you feeling today? Any thoughts, patterns, or observations..."
                                  class="w-full px-3 py-2 border border-sage-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sage-500 focus:border-transparent resize-none"></textarea>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" 
                            class="w-full bg-sage-600 hover:bg-sage-700 text-white px-6 py-3 rounded-lg transition-colors duration-200 flex items-center justify-center">
                            <i class="fas fa-save mr-2"></i>Save Entry
                        </button>
                </form>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="content-dashboard" class="tab-content" style="display: none;">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Quick Stats -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-sage-800 mb-4">
                            <i class="fas fa-chart-bar mr-2"></i>Quick Stats
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-sage-600" id="total-entries">0</div>
                                <div class="text-sm text-sage-500">Total Entries</div>
                        </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600" id="avg-mood">0</div>
                                <div class="text-sm text-sage-500">Avg Mood</div>
                        </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600" id="avg-energy">0</div>
                                <div class="text-sm text-sage-500">Avg Energy</div>
                    </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-red-600" id="avg-pain">0</div>
                                <div class="text-sm text-sage-500">Avg Pain</div>
                </div>
                    </div>
                </div>

                    <!-- Recent Trends -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-sage-800 mb-4">
                            <i class="fas fa-trending-up mr-2"></i>Recent Trends
                        </h3>
                                                <div id="trends-chart" class="h-48">
                            <canvas id="trendsCanvas" width="400" height="200"></canvas>
                        </div>
                        </div>
                    </div>

                                <!-- Export Section -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-sage-800 mb-4">
                        <i class="fas fa-download mr-2"></i>Export Your Data
                    </h3>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="exportToCSV()" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center">
                            <i class="fas fa-file-csv mr-2"></i>Export to CSV
                        </button>
                        <button onclick="exportToJSON()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center">
                            <i class="fas fa-file-code mr-2"></i>Export to JSON
                        </button>
                        <button onclick="exportToPDF()" 
                                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center">
                            <i class="fas fa-file-pdf mr-2"></i>Export to PDF
                        </button>
                        <button onclick="printReport()" 
                                class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center">
                            <i class="fas fa-print mr-2"></i>Print Report
                        </button>
                    </div>
                </div>
                
                <!-- Recent Entries Summary -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-sage-800 mb-4">
                        <i class="fas fa-history mr-2"></i>Recent Entries
                    </h3>
                    <div id="recent-entries" class="space-y-3">
                        <!-- Recent entries will be loaded here -->
                    </div>
                </div>
                    </div>

            <!-- All Entries Tab -->
            <div id="content-entries" class="tab-content" style="display: none;">
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-sage-800 mb-4">
                        <i class="fas fa-list mr-2"></i>All Your Entries
                    </h3>
                    <div id="all-entries-list" class="space-y-4">
                        <!-- All entries will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- AI Coach Tab -->
            <div id="content-ai-coach" class="tab-content" style="display: none;">
                <div class="bg-white rounded-lg shadow-lg p-4 md:p-6 mb-4 md:mb-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 space-y-2 md:space-y-0">
                        <h3 class="text-base md:text-lg font-semibold text-sage-800">
                            <i class="fas fa-robot mr-2 text-purple-600"></i>Meet Chroni, Your AI Health Coach
                        </h3>
                        <div id="ai-usage-display" class="text-xs md:text-sm text-gray-600">
                            <!-- Usage will be shown here -->
                        </div>
                    </div>
                    
                    <!-- AI Chat Interface -->
                    <div id="ai-chat-container" class="border rounded-lg p-3 md:p-4 mb-3 md:mb-4 max-h-80 md:max-h-96 overflow-y-auto bg-gray-50">
                        <div id="ai-welcome-message" class="text-center text-gray-600 py-4 md:py-8">
                            <div class="text-3xl md:text-4xl mb-2">ü§ñ</div>
                            <p class="mb-2 text-sm md:text-base">Hi! I'm Chroni, your AI health companion.</p>
                            <p class="text-xs md:text-sm">Ask me anything about your health patterns, symptoms, or how you're feeling today!</p>
                        </div>
                        <div id="ai-chat-messages" class="space-y-2 md:space-y-4">
                            <!-- AI conversation will appear here -->
                        </div>
                    </div>

                    <!-- AI Input Area -->
                    <div id="ai-input-container" class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 pb-2">
                        <input type="text" id="ai-question-input" 
                               placeholder="Ask me about your health..."
                               class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm md:text-base"
                               maxlength="200">
                        <button id="ai-ask-btn" 
                                class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 md:px-6 py-3 rounded-lg hover:from-purple-700 hover:to-pink-700 font-medium transition-all duration-200 shadow-lg hover:shadow-xl text-sm md:text-base">
                            <i class="fas fa-paper-plane mr-1 md:mr-2"></i>Ask Chroni
                        </button>
                    </div>
                    
                    <!-- Premium Upgrade Prompt -->
                    <div id="ai-premium-prompt" class="mt-3 md:mt-4 p-3 md:p-4 bg-gradient-to-r from-purple-100 to-pink-100 rounded-lg border border-purple-200" style="display: none;">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-2 md:space-y-0">
                            <div>
                                <h4 class="font-semibold text-purple-800 mb-1 text-sm md:text-base">Unlock Unlimited AI Coaching</h4>
                                <p class="text-xs md:text-sm text-purple-700">Get unlimited daily insights and advanced health analytics!</p>
                            </div>
                            <button class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-medium hover:from-purple-700 hover:to-pink-700 w-full md:w-auto">
                                Upgrade - $9.99/mo
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Health Insights -->
                    <div class="mt-4 md:mt-6 grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">
                        <button class="ai-quick-question p-3 text-left border border-gray-200 rounded-lg hover:bg-purple-50 hover:border-purple-300 transition-colors" data-question="How am I doing overall?">
                            <div class="text-xs md:text-sm font-medium text-gray-800">üìä Overall Health</div>
                            <div class="text-xs text-gray-600 mt-1">How am I doing overall?</div>
                        </button>
                        <button class="ai-quick-question p-3 text-left border border-gray-200 rounded-lg hover:bg-purple-50 hover:border-purple-300 transition-colors" data-question="What patterns do you see in my data?">
                            <div class="text-xs md:text-sm font-medium text-gray-800">üîç Pattern Analysis</div>
                            <div class="text-xs text-gray-600 mt-1">What patterns do you see?</div>
                        </button>
                        <button class="ai-quick-question p-3 text-left border border-gray-200 rounded-lg hover:bg-purple-50 hover:border-purple-300 transition-colors" data-question="Any suggestions for today?">
                            <div class="text-xs md:text-sm font-medium text-gray-800">üí° Daily Tips</div>
                            <div class="text-xs text-gray-600 mt-1">Suggestions for today?</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    <!-- Working Authentication Script -->
    <script src="js/working-auth.js?v=SIGNOUT-DEBUG-v30000-1754440000"></script>
    
    <!-- App Functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Enter Key Support for Authentication
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            
            const handleEnterKey = (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    window.workingAuth?.signInWithEmail();
                }
            };
            
            if (emailInput) emailInput.addEventListener('keypress', handleEnterKey);
            if (passwordInput) passwordInput.addEventListener('keypress', handleEnterKey);
            
            // Slider Functionality
            const sliders = [
                { slider: 'mood-slider', value: 'mood-value' },
                { slider: 'energy-slider', value: 'energy-value' },
                { slider: 'pain-slider', value: 'pain-value' },
                { slider: 'sleep-slider', value: 'sleep-value' }
            ];
            
            sliders.forEach(({ slider, value }) => {
                const sliderEl = document.getElementById(slider);
                const valueEl = document.getElementById(value);
                
                if (sliderEl && valueEl) {
                    sliderEl.addEventListener('input', (e) => {
                        valueEl.textContent = e.target.value;
                    });
                }
            });
            
            // Set today's date as default
            const entryDate = document.getElementById('entry-date');
            if (entryDate) {
                const today = new Date().toISOString().split('T')[0];
                entryDate.value = today;
            }
            
            // New Entry Form Submission
            const newEntryForm = document.getElementById('new-entry-form');
            if (newEntryForm) {
                newEntryForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await saveNewEntry();
                });
            }
            
            // Tab Navigation
            const tabButtons = document.querySelectorAll('[id^="tab-"]');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.id.replace('tab-', '');
                    switchTab(tabName);
                });
            });
            
            console.log('‚úÖ App functionality initialized');
        });
        
        // Save New Entry Function
        async function saveNewEntry() {
            const date = document.getElementById('entry-date').value;
            const mood = document.getElementById('mood-slider').value;
            const energy = document.getElementById('energy-slider').value;
            const pain = document.getElementById('pain-slider').value;
            const sleep = document.getElementById('sleep-slider').value;
            const notes = document.getElementById('entry-notes').value;
            const medications = document.getElementById('medications').value;
            const activities = document.getElementById('activities').value;
            const weather = document.getElementById('weather').value;
            
            // Get checked symptoms
            const symptoms = [];
            const symptomIds = ['headache', 'fatigue', 'nausea', 'dizziness', 'anxiety', 'brain-fog'];
            symptomIds.forEach(symptom => {
                const checkbox = document.getElementById(`symptom-${symptom}`);
                if (checkbox && checkbox.checked) {
                    symptoms.push(symptom);
                }
            });
            
            if (!date) {
                alert('Please select a date for your entry.');
                return;
            }
            
            const entry = {
                id: Date.now(), // Simple ID for now
                date: date,
                mood: parseInt(mood),
                energy: parseInt(energy),
                pain: parseInt(pain),
                sleep: parseInt(sleep),
                symptoms: symptoms,
                medications: medications.trim(),
                activities: activities.trim(),
                weather: weather,
                notes: notes.trim(),
                created_at: new Date().toISOString()
            };
            
            console.log('üíæ Saving entry to Supabase:', entry);
            
            try {
                // Save to Supabase database
                const { data, error } = await window.supabase
                    .from('health_entries')
                    .insert([{
                        user_id: (await window.supabase.auth.getUser()).data.user?.id,
                        entry_date: entry.date,
                        mood: entry.mood,
                        energy: entry.energy,
                        pain: entry.pain,
                        sleep: entry.sleep,
                        symptoms: entry.symptoms,
                        medications: entry.medications,
                        activities: entry.activities,
                        weather: entry.weather,
                        notes: entry.notes,
                        created_at: entry.created_at
                    }]);

                if (error) {
                    console.error('‚ùå Error saving entry to Supabase:', error);
                    alert('‚ùå Failed to save entry. Please try again.');
                    return;
                }

                console.log('‚úÖ Entry saved to Supabase successfully:', data);
                // Show success message
                alert('‚úÖ Entry saved successfully!');
            } catch (saveError) {
                console.error('‚ùå Exception saving entry:', saveError);
                alert('‚ùå Failed to save entry. Please check your connection and try again.');
                return;
            }
            
            // Reset form
            document.getElementById('new-entry-form').reset();
            document.getElementById('entry-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('mood-value').textContent = '5';
            document.getElementById('energy-value').textContent = '5';
            document.getElementById('pain-value').textContent = '0';
            document.getElementById('sleep-value').textContent = '5';
            
            // Refresh entries list and dashboard
            await loadEntries();
            await updateDashboard();
            
            // Update chart after saving
            setTimeout(() => {
                createTrendsChart();
            }, 100);
        }
        
        // Load and display entries
        async function loadEntries() {
            const entriesList = document.getElementById('entries-list');
            if (!entriesList) return;
            
            try {
                // Get current user
                const user = await window.supabase.auth.getUser();
                if (!user.data.user) {
                    console.error('No authenticated user for loadEntries');
                    return;
                }
                
                const { data: entries, error } = await window.supabase
                    .from('health_entries')
                    .select('*')
                    .eq('user_id', user.data.user.id)
                    .order('entry_date', { ascending: false });

                if (error) {
                    console.error('Error loading entries:', error);
                    entriesList.innerHTML = `
                        <div class="text-center py-8 text-red-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <p>Error loading entries. Please try again.</p>
                        </div>
                    `;
                    return;
                }

                const entriesArray = entries || [];
            
                if (entriesArray.length === 0) {
                    entriesList.innerHTML = `
                        <div class="text-center py-8 text-sage-500">
                            <i class="fas fa-journal-whills text-4xl mb-4"></i>
                            <p>No entries yet. Create your first entry above!</p>
                        </div>
                    `;
                    return;
                }
                
                entriesList.innerHTML = entriesArray.map(entry => `
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-sage-500">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-semibold text-sage-800">${new Date(entry.entry_date).toLocaleDateString()}</h3>
                        <div class="text-sm text-sage-500">
                            ${new Date(entry.created_at).toLocaleTimeString()}
                            </div>
                        </div>

                    <!-- Main metrics -->
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div class="flex items-center">
                            <span class="text-sm text-sage-600 mr-2">Mood:</span>
                            <div class="flex items-center">
                                <span class="font-semibold text-sage-800">${entry.mood}/10</span>
                                <div class="ml-2 text-lg">${getMoodEmoji(entry.mood)}</div>
                            </div>
                            </div>
                        <div class="flex items-center">
                            <span class="text-sm text-sage-600 mr-2">Energy:</span>
                            <div class="flex items-center">
                                <span class="font-semibold text-sage-800">${entry.energy}/10</span>
                                <div class="ml-2 text-lg">${getEnergyEmoji(entry.energy)}</div>
                        </div>
                    </div>
                        ${entry.pain !== undefined ? `
                        <div class="flex items-center">
                            <span class="text-sm text-sage-600 mr-2">Pain:</span>
                            <div class="flex items-center">
                                <span class="font-semibold text-sage-800">${entry.pain}/10</span>
                                <div class="ml-2 text-lg">${getPainEmoji(entry.pain)}</div>
                            </div>
                            </div>
                        ` : ''}
                        ${entry.sleep !== undefined ? `
                        <div class="flex items-center">
                            <span class="text-sm text-sage-600 mr-2">Sleep:</span>
                            <div class="flex items-center">
                                <span class="font-semibold text-sage-800">${entry.sleep}/10</span>
                                <div class="ml-2 text-lg">${getSleepEmoji(entry.sleep)}</div>
                        </div>
                        </div>
                        ` : ''}
                    </div>

                    <!-- Symptoms -->
                    ${entry.symptoms && entry.symptoms.length > 0 ? `
                    <div class="mb-3">
                        <span class="text-sm text-sage-600 font-medium">Symptoms:</span>
                        <div class="flex flex-wrap gap-1 mt-1">
                            ${entry.symptoms.map(symptom => `
                                <span class="inline-block bg-red-100 text-red-800 text-xs px-2 py-1 rounded">
                                    ${getSymptomDisplay(symptom)}
                                </span>
                            `).join('')}
                        </div>
                        </div>
                    ` : ''}
                    
                    <!-- Weather -->
                    ${entry.weather ? `
                    <div class="mb-3">
                        <span class="text-sm text-sage-600 mr-2">Weather:</span>
                        <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">
                            ${getWeatherDisplay(entry.weather)}
                        </span>
                    </div>
                    ` : ''}
                    
                    <!-- Medications -->
                    ${entry.medications ? `
                    <div class="mb-3">
                        <span class="text-sm text-sage-600 font-medium">Medications:</span>
                        <p class="text-sage-700 text-sm bg-green-50 p-2 rounded mt-1">${entry.medications}</p>
    </div>
                    ` : ''}
                    
                    <!-- Activities -->
                    ${entry.activities ? `
                    <div class="mb-3">
                        <span class="text-sm text-sage-600 font-medium">Activities:</span>
                        <p class="text-sage-700 text-sm bg-purple-50 p-2 rounded mt-1">${entry.activities}</p>
    </div>
                    ` : ''}
                    
                    <!-- Notes -->
                    ${entry.notes ? `
                    <div class="mb-3">
                        <span class="text-sm text-sage-600 font-medium">Notes:</span>
                        <p class="text-sage-700 text-sm bg-sage-50 p-2 rounded mt-1">${entry.notes}</p>
            </div>
                    ` : ''}
            </div>
            `).join('');
            } catch (error) {
                console.error('‚ùå Error loading entries:', error);
                entriesList.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Error loading entries. Please try again.</p>
                    </div>
                `;
            }
        }
        
        // Helper functions for emojis
        function getMoodEmoji(mood) {
            if (mood <= 3) return 'üò¢';
            if (mood <= 5) return 'üòê';
            if (mood <= 7) return 'üôÇ';
            return 'üòä';
        }
        
        function getEnergyEmoji(energy) {
            if (energy <= 3) return '‚ö°';
            if (energy <= 7) return 'üîã';
            return 'üöÄ';
        }
        
        function getPainEmoji(pain) {
            if (pain === 0) return 'üòå';
            if (pain <= 3) return 'üòê';
            if (pain <= 6) return 'üò£';
            return 'üòñ';
        }
        
        function getSleepEmoji(sleep) {
            if (sleep <= 3) return 'üò¥';
            if (sleep <= 7) return 'üòê';
            return 'üòä';
        }
        
        function getSymptomDisplay(symptom) {
            const symptoms = {
                'headache': 'ü§ï Headache',
                'fatigue': 'üò¥ Fatigue',
                'nausea': 'ü§¢ Nausea',
                'dizziness': 'üí´ Dizziness',
                'anxiety': 'üò∞ Anxiety',
                'brain-fog': 'üß† Brain Fog'
            };
            return symptoms[symptom] || symptom;
        }
        
        function getWeatherDisplay(weather) {
            const weatherOptions = {
                'sunny': '‚òÄÔ∏è Sunny',
                'cloudy': '‚òÅÔ∏è Cloudy',
                'rainy': 'üåßÔ∏è Rainy',
                'stormy': '‚õàÔ∏è Stormy',
                'snowy': '‚ùÑÔ∏è Snowy',
                'windy': 'üí® Windy',
                'humid': 'üíß Humid',
                'cold': 'ü•∂ Cold',
                'hot': 'ü•µ Hot'
            };
            return weatherOptions[weather] || weather;
        }
        
        // Tab Navigation
        function switchTab(tabName) {
            // Update button styles
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('bg-sage-600', 'text-white');
                btn.classList.add('text-sage-600', 'hover:bg-sage-100');
            });
            
            document.getElementById(`tab-${tabName}`).classList.add('bg-sage-600', 'text-white');
            document.getElementById(`tab-${tabName}`).classList.remove('text-sage-600', 'hover:bg-sage-100');
            
            // Show/hide content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            document.getElementById(`content-${tabName}`).style.display = 'block';
            
            // Load content based on tab
            if (tabName === 'dashboard') {
                updateDashboard();
                setTimeout(() => {
                    createTrendsChart();
                }, 100);
            } else if (tabName === 'entries') {
                loadAllEntries();
            } else if (tabName === 'ai-coach') {
                initializeAICoach();
            }
        }
        
        // Reset quick stats to zero
        function resetQuickStats() {
            console.log('üìä Resetting quick stats to 0');
            const totalEntriesEl = document.getElementById('total-entries');
            const avgMoodEl = document.getElementById('avg-mood');
            const avgEnergyEl = document.getElementById('avg-energy');
            const avgPainEl = document.getElementById('avg-pain');
            
            if (totalEntriesEl) totalEntriesEl.textContent = '0';
            if (avgMoodEl) avgMoodEl.textContent = '0';
            if (avgEnergyEl) avgEnergyEl.textContent = '0';
            if (avgPainEl) avgPainEl.textContent = '0';
        }
        
        // Update Dashboard
        async function updateDashboard() {
            try {
                // Get current user
                const user = await window.supabase.auth.getUser();
                if (!user.data.user) {
                    console.error('No authenticated user for updateDashboard');
                    return;
                }
                
                const { data: entries, error } = await window.supabase
                    .from('health_entries')
                    .select('*')
                    .eq('user_id', user.data.user.id)
                    .order('entry_date', { ascending: false });

                if (error) {
                    console.error('Error loading dashboard data:', error);
                    return;
                }

                const entriesArray = entries || [];
            
                // Quick Stats
                document.getElementById('total-entries').textContent = entriesArray.length;
                
                if (entriesArray.length > 0) {
                    const avgMood = (entriesArray.reduce((sum, entry) => sum + (entry.mood || 0), 0) / entriesArray.length).toFixed(1);
                    const avgEnergy = (entriesArray.reduce((sum, entry) => sum + (entry.energy || 0), 0) / entriesArray.length).toFixed(1);
                    const avgPain = (entriesArray.reduce((sum, entry) => sum + (entry.pain || 0), 0) / entriesArray.length).toFixed(1);
                    
                    document.getElementById('avg-mood').textContent = avgMood;
                    document.getElementById('avg-energy').textContent = avgEnergy;
                    document.getElementById('avg-pain').textContent = avgPain;
                } else {
                    // Reset stats to 0 when no entries
                    console.log('üìä No entries found - resetting quick stats to 0');
                    resetQuickStats();
                }
                
                // Recent Entries (last 5)
                const recentEntries = entriesArray.slice(0, 5);
            const recentContainer = document.getElementById('recent-entries');
            
            if (recentEntries.length === 0) {
                recentContainer.innerHTML = '<p class="text-sage-500 text-center py-4">No entries yet. Create your first entry!</p>';
            } else {
                recentContainer.innerHTML = recentEntries.map(entry => `
                    <div class="flex justify-between items-center p-3 bg-sage-50 rounded-lg">
                        <div>
                            <div class="font-medium text-sage-800">${new Date(entry.entry_date).toLocaleDateString()}</div>
                            <div class="text-sm text-sage-600">
                                Mood: ${entry.mood}/10 | Energy: ${entry.energy}/10 | Pain: ${entry.pain || 0}/10
                            </div>
                        </div>
                        <div class="text-lg">
                            ${getMoodEmoji(entry.mood)} ${getEnergyEmoji(entry.energy)}
                        </div>
                    </div>
                `).join('');
            }
            
            } catch (error) {
                console.error('Error updating dashboard:', error);
                // Don't reset stats here - let the main logic handle empty data properly
                const recentContainer = document.getElementById('recent-entries');
                if (recentContainer) {
                    recentContainer.innerHTML = '<p class="text-red-500 text-center py-4">Error loading dashboard data. Please try refreshing.</p>';
                }
            }
        }
        
        // Load All Entries
        async function loadAllEntries() {
            const allEntriesContainer = document.getElementById('all-entries-list');
            
            try {
                // Get current user
                const user = await window.supabase.auth.getUser();
                if (!user.data.user) {
                    console.error('No authenticated user for loadAllEntries');
                    return;
                }
                
                const { data: entries, error } = await window.supabase
                    .from('health_entries')
                    .select('*')
                    .eq('user_id', user.data.user.id)
                    .order('entry_date', { ascending: false });

                if (error) {
                    console.error('Error loading entries:', error);
                    allEntriesContainer.innerHTML = `
                        <div class="text-center py-8 text-red-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <p>Error loading entries. Please try again.</p>
                        </div>
                    `;
                    return;
                }

                if (!entries || entries.length === 0) {
                    allEntriesContainer.innerHTML = `
                        <div class="text-center py-8 text-sage-500">
                            <i class="fas fa-journal-whills text-4xl mb-4"></i>
                            <p>No entries yet. Create your first entry!</p>
                        </div>
                    `;
                    return;
                }

                // Use the same display logic as the main entries list - MOVED INSIDE try block
                allEntriesContainer.innerHTML = entries.map(entry => `
                <div class="bg-white rounded-lg shadow-md p-4 border-l-4 border-sage-500">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-semibold text-sage-800">${new Date(entry.entry_date).toLocaleDateString()}</h3>
                        <div class="text-sm text-sage-500">
                            ${new Date(entry.created_at).toLocaleTimeString()}
                        </div>
                    </div>
                    
                    <!-- Main metrics -->
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div class="flex items-center">
                            <span class="text-sm text-sage-600 mr-2">Mood:</span>
                            <div class="flex items-center">
                                <span class="font-semibold text-sage-800">${entry.mood}/10</span>
                                <div class="ml-2 text-lg">${getMoodEmoji(entry.mood)}</div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span class="text-sm text-sage-600 mr-2">Energy:</span>
                            <div class="flex items-center">
                                <span class="font-semibold text-sage-800">${entry.energy}/10</span>
                                <div class="ml-2 text-lg">${getEnergyEmoji(entry.energy)}</div>
                            </div>
                        </div>
                        ${entry.pain !== undefined ? `
                        <div class="flex items-center">
                            <span class="text-sm text-sage-600 mr-2">Pain:</span>
                            <div class="flex items-center">
                                <span class="font-semibold text-sage-800">${entry.pain}/10</span>
                                <div class="ml-2 text-lg">${getPainEmoji(entry.pain)}</div>
                            </div>
                        </div>
                        ` : ''}
                        ${entry.sleep !== undefined ? `
                        <div class="flex items-center">
                            <span class="text-sm text-sage-600 mr-2">Sleep:</span>
                            <div class="flex items-center">
                                <span class="font-semibold text-sage-800">${entry.sleep}/10</span>
                                <div class="ml-2 text-lg">${getSleepEmoji(entry.sleep)}</div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Symptoms -->
                    ${entry.symptoms && entry.symptoms.length > 0 ? `
                    <div class="mb-3">
                        <span class="text-sm text-sage-600 font-medium">Symptoms:</span>
                        <div class="flex flex-wrap gap-1 mt-1">
                            ${entry.symptoms.map(symptom => `
                                <span class="inline-block bg-red-100 text-red-800 text-xs px-2 py-1 rounded">
                                    ${getSymptomDisplay(symptom)}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Weather -->
                    ${entry.weather ? `
                    <div class="mb-3">
                        <span class="text-sm text-sage-600 mr-2">Weather:</span>
                        <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">
                            ${getWeatherDisplay(entry.weather)}
                        </span>
                    </div>
                    ` : ''}
                    
                    <!-- Medications -->
                    ${entry.medications ? `
                    <div class="mb-3">
                        <span class="text-sm text-sage-600 font-medium">Medications:</span>
                        <p class="text-sage-700 text-sm bg-green-50 p-2 rounded mt-1">${entry.medications}</p>
                    </div>
                    ` : ''}
                    
                    <!-- Activities -->
                    ${entry.activities ? `
                    <div class="mb-3">
                        <span class="text-sm text-sage-600 font-medium">Activities:</span>
                        <p class="text-sage-700 text-sm bg-purple-50 p-2 rounded mt-1">${entry.activities}</p>
                    </div>
                    ` : ''}
                    
                    <!-- Notes -->
                    ${entry.notes ? `
                    <div class="mb-3">
                        <span class="text-sm text-sage-600 font-medium">Notes:</span>
                        <p class="text-sage-700 text-sm bg-sage-50 p-2 rounded mt-1">${entry.notes}</p>
                    </div>
                    ` : ''}
                </div>
            `).join('');

            } catch (error) {
                console.error('Error loading entries:', error);
                allEntriesContainer.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Error loading entries. Please try again.</p>
                    </div>
                `;
            }
        }
        
        // Global chart variable to track existing chart
        let trendsChart = null;
        
        // Create Trends Chart
        async function createTrendsChart() {
            try {
                // Get current user
                const user = await window.supabase.auth.getUser();
                if (!user.data.user) {
                    console.error('No authenticated user for createTrendsChart');
                    return;
                }
                
                const { data: entries, error } = await window.supabase
                    .from('health_entries')
                    .select('*')
                    .eq('user_id', user.data.user.id)
                    .order('entry_date', { ascending: false });

                if (error) {
                    console.error('Error loading chart data:', error);
                    return;
                }

                const entriesArray = entries || [];
            const canvas = document.getElementById('trendsCanvas');
            
            if (!canvas) {
                console.log('Canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (trendsChart) {
                trendsChart.destroy();
            }
            
            if (entriesArray.length === 0) {
                // Show "no data" message
                ctx.fillStyle = '#9CA3AF';
                ctx.font = '16px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No entries yet - create your first entry!', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Sort entries by date
            entriesArray.sort((a, b) => new Date(a.entry_date) - new Date(b.entry_date));
            
            // Prepare data
            const labels = entriesArray.map(entry => {
                const date = new Date(entry.entry_date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            const moodData = entriesArray.map(entry => entry.mood || null);
            const energyData = entriesArray.map(entry => entry.energy || null);
            const painData = entriesArray.map(entry => entry.pain || null);
            
            // Create the chart
            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Mood',
                            data: moodData,
                            borderColor: '#5a6e5a',
                            backgroundColor: 'rgba(90, 110, 90, 0.1)',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Energy',
                            data: energyData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Pain',
                            data: painData,
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Rating (0-10)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Health Trends Over Time'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
            
            } catch (error) {
                console.error('Error creating trends chart:', error);
                const canvas = document.getElementById('trendsCanvas');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#EF4444';
                    ctx.font = '16px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('Error loading chart data', canvas.width / 2, canvas.height / 2);
                }
            }
        }
        
        // Export Functions
        async function exportToCSV() {
            try {
                // Get current user
                const user = await window.supabase.auth.getUser();
                if (!user.data.user) {
                    console.error('No authenticated user for exportToCSV');
                    alert('Please sign in to export data.');
                    return;
                }
                
                // Fetch entries from Supabase database
                const { data: entries, error } = await window.supabase
                    .from('health_entries')
                    .select('*')
                    .eq('user_id', user.data.user.id)
                    .order('entry_date', { ascending: false });

                if (error) {
                    console.error('‚ùå Error fetching entries for CSV export:', error);
                    alert('Error loading entries for export. Please try again.');
                    return;
                }

                if (!entries || entries.length === 0) {
                    alert('No entries to export!');
                    return;
                }
            
            // CSV headers
            const headers = ['Date', 'Mood', 'Energy', 'Pain', 'Sleep', 'Symptoms', 'Medications', 'Activities', 'Weather', 'Notes'];
            
            // Convert entries to CSV format
            const csvData = entries.map(entry => {
                return [
                    entry.entry_date || '',
                    entry.mood || '',
                    entry.energy || '',
                    entry.pain || '',
                    entry.sleep || '',
                    (entry.symptoms || []).join('; '),
                    entry.medications || '',
                    entry.activities || '',
                    entry.weather || '',
                    entry.notes || ''
                ].map(field => `"${field}"`).join(',');
            });
            
            // Combine headers and data
            const csv = [headers.join(','), ...csvData].join('\n');
            
            // Create and download file
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chronicompanion-entries-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            console.log('‚úÖ CSV export completed');
            
            } catch (error) {
                console.error('‚ùå CSV export failed:', error);
                alert('Failed to export CSV. Please try again.');
            }
        }
        
        async function exportToJSON() {
            try {
                // Get current user
                const user = await window.supabase.auth.getUser();
                if (!user.data.user) {
                    console.error('No authenticated user for exportToJSON');
                    alert('Please sign in to export data.');
                    return;
                }
                
                // Fetch entries from Supabase database
                const { data: entries, error } = await window.supabase
                    .from('health_entries')
                    .select('*')
                    .eq('user_id', user.data.user.id)
                    .order('entry_date', { ascending: false });

                if (error) {
                    console.error('‚ùå Error fetching entries for JSON export:', error);
                    alert('Error loading entries for export. Please try again.');
                    return;
                }

                if (!entries || entries.length === 0) {
                    alert('No entries to export!');
                    return;
                }
            
            // Create export object with metadata
            const exportData = {
                exported_at: new Date().toISOString(),
                app_version: 'ChroniCompanion v1.3',
                total_entries: entries.length,
                entries: entries
            };
            
            // Create and download file
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chronicompanion-entries-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            console.log('‚úÖ JSON export completed');
            
            } catch (error) {
                console.error('‚ùå JSON export failed:', error);
                alert('Failed to export JSON. Please try again.');
            }
        }
        
        function printReport() {
            const entries = JSON.parse(localStorage.getItem('chronicompanion_entries') || '[]');
            
            if (entries.length === 0) {
                alert('No entries to print!');
                return;
            }
            
            // Calculate statistics
            const totalEntries = entries.length;
            const avgMood = entries.length > 0 ? (entries.reduce((sum, entry) => sum + (entry.mood || 0), 0) / entries.length).toFixed(1) : 'N/A';
            const avgEnergy = entries.length > 0 ? (entries.reduce((sum, entry) => sum + (entry.energy || 0), 0) / entries.length).toFixed(1) : 'N/A';
            const avgPain = entries.length > 0 ? (entries.reduce((sum, entry) => sum + (entry.pain || 0), 0) / entries.length).toFixed(1) : 'N/A';
            
            // Create printable HTML
            const printContent = `
                <html>
                <head>
                    <title>ChroniCompanion Health Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #5a6e5a; padding-bottom: 20px; }
                        .stats { display: flex; justify-content: space-around; margin: 20px 0; }
                        .stat-box { text-align: center; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
                        .entry { margin: 20px 0; padding: 15px; border: 1px solid #eee; border-left: 4px solid #5a6e5a; }
                        .entry-date { font-weight: bold; color: #5a6e5a; margin-bottom: 10px; }
                        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 10px 0; }
                        .metric { padding: 5px; background: #f9f9f9; border-radius: 3px; }
                        .notes { margin-top: 10px; padding: 10px; background: #f6f7f6; border-radius: 5px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üå± ChroniCompanion Health Report</h1>
                        <p>Generated on ${new Date().toLocaleDateString()}</p>
                        <p>Total Entries: ${totalEntries}</p>
                    </div>
                    
                    <div class="stats">
                        <div class="stat-box">
                            <h3>Average Mood</h3>
                            <p>${avgMood}/10</p>
                        </div>
                        <div class="stat-box">
                            <h3>Average Energy</h3>
                            <p>${avgEnergy}/10</p>
                        </div>
                        <div class="stat-box">
                            <h3>Average Pain</h3>
                            <p>${avgPain}/10</p>
                        </div>
                    </div>
                    
                    <h2>Recent Entries</h2>
                    ${entries.slice(0, 10).map(entry => `
                        <div class="entry">
                            <div class="entry-date">${new Date(entry.date).toLocaleDateString()}</div>
                            <div class="metrics">
                                <div class="metric">Mood: ${entry.mood}/10 ${getMoodEmoji(entry.mood)}</div>
                                <div class="metric">Energy: ${entry.energy}/10 ${getEnergyEmoji(entry.energy)}</div>
                                ${entry.pain !== undefined ? `<div class="metric">Pain: ${entry.pain}/10 ${getPainEmoji(entry.pain)}</div>` : ''}
                                ${entry.sleep !== undefined ? `<div class="metric">Sleep: ${entry.sleep}/10 ${getSleepEmoji(entry.sleep)}</div>` : ''}
                            </div>
                            ${entry.symptoms && entry.symptoms.length > 0 ? `<div><strong>Symptoms:</strong> ${entry.symptoms.join(', ')}</div>` : ''}
                            ${entry.medications ? `<div><strong>Medications:</strong> ${entry.medications}</div>` : ''}
                            ${entry.activities ? `<div><strong>Activities:</strong> ${entry.activities}</div>` : ''}
                            ${entry.weather ? `<div><strong>Weather:</strong> ${entry.weather}</div>` : ''}
                            ${entry.notes ? `<div class="notes"><strong>Notes:</strong> ${entry.notes}</div>` : ''}
                        </div>
                    `).join('')}
                </body>
                </html>
            `;
            
            // Open print dialog
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
            
            console.log('‚úÖ Print report opened');
        }
        
        // PDF Export Function (updated to fetch from Supabase)
        async function exportToPDF() {
            try {
                // Get current user
                const user = await window.supabase.auth.getUser();
                if (!user.data.user) {
                    console.error('No authenticated user for exportToPDF');
                    alert('Please sign in to export data.');
                    return;
                }
                
                // Fetch entries from Supabase database instead of localStorage
                const { data: entries, error } = await window.supabase
                    .from('health_entries')
                    .select('*')
                    .eq('user_id', user.data.user.id)
                    .order('entry_date', { ascending: false });

                if (error) {
                    console.error('‚ùå Error fetching entries for PDF export:', error);
                    alert('Error loading entries for export. Please try again.');
                    return;
                }

                if (!entries || entries.length === 0) {
                    alert('No entries to export!');
                    return;
                }

                console.log('üìÑ Exporting', entries.length, 'entries to PDF');
            
            // Initialize jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Colors (matching old service)
            const sageGreen = [90, 110, 90];
            const lightGray = [246, 247, 246];
            
            let yPosition = 20;
            
            // Title
            doc.setFontSize(24);
            doc.setTextColor(...sageGreen);
            doc.text('ChroniCompanion', 105, yPosition, { align: 'center' });
            yPosition += 15;
            
            doc.setFontSize(18);
            doc.text('Health Journal Report', 105, yPosition, { align: 'center' });
            yPosition += 20;
            
            // Report metadata
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Report Generated: ${new Date().toLocaleDateString()}`, 20, yPosition);
            yPosition += 8;
            doc.text(`Total Entries: ${entries.length}`, 20, yPosition);
            yPosition += 8;
            
            if (entries.length > 0) {
                const sortedEntries = entries.sort((a, b) => new Date(a.entry_date) - new Date(b.entry_date));
                const dateRange = sortedEntries.length === 1 
                    ? sortedEntries[0].entry_date 
                    : `${sortedEntries[0].entry_date} to ${sortedEntries[sortedEntries.length - 1].entry_date}`;
                doc.text(`Date Range: ${dateRange}`, 20, yPosition);
                yPosition += 15;
            }
            
            // Summary Statistics
            doc.setFontSize(16);
            doc.setTextColor(...sageGreen);
            doc.text('Summary Statistics', 20, yPosition);
            yPosition += 10;
            
            if (entries.length > 0) {
                const avgMood = (entries.reduce((sum, entry) => sum + (entry.mood || 0), 0) / entries.length).toFixed(1);
                const avgEnergy = (entries.reduce((sum, entry) => sum + (entry.energy || 0), 0) / entries.length).toFixed(1);
                const avgPain = (entries.reduce((sum, entry) => sum + (entry.pain || 0), 0) / entries.length).toFixed(1);
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Average Mood Level: ${avgMood}/10`, 20, yPosition);
                yPosition += 6;
                doc.text(`Average Energy Level: ${avgEnergy}/10`, 20, yPosition);
                yPosition += 6;
                doc.text(`Average Pain Level: ${avgPain}/10`, 20, yPosition);
                yPosition += 15;
            }
            
            // Recent Entries (limit to first 10 to fit in PDF)
            doc.setFontSize(16);
            doc.setTextColor(...sageGreen);
            doc.text('Recent Entries', 20, yPosition);
            yPosition += 10;
            
            const recentEntries = entries.slice(0, 10);
            
            recentEntries.forEach((entry, index) => {
                // Check if we need a new page
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Entry header
                doc.setFontSize(14);
                doc.setTextColor(...sageGreen);
                doc.text(`${new Date(entry.entry_date).toLocaleDateString()}`, 20, yPosition);
                yPosition += 8;
                
                // Entry content
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                // Ratings
                const ratings = [];
                if (entry.mood !== undefined) ratings.push(`Mood: ${entry.mood}/10`);
                if (entry.energy !== undefined) ratings.push(`Energy: ${entry.energy}/10`);
                if (entry.pain !== undefined) ratings.push(`Pain: ${entry.pain}/10`);
                if (entry.sleep !== undefined) ratings.push(`Sleep: ${entry.sleep}/10`);
                
                if (ratings.length > 0) {
                    doc.text(`Ratings: ${ratings.join(' | ')}`, 25, yPosition);
                    yPosition += 6;
                }
                
                // Symptoms
                if (entry.symptoms && entry.symptoms.length > 0) {
                    doc.text(`Symptoms: ${entry.symptoms.join(', ')}`, 25, yPosition);
                    yPosition += 6;
                }
                
                // Medications
                if (entry.medications) {
                    const medicationsText = doc.splitTextToSize(`Medications: ${entry.medications}`, 170);
                    doc.text(medicationsText, 25, yPosition);
                    yPosition += medicationsText.length * 4;
                }
                
                // Activities
                if (entry.activities) {
                    const activitiesText = doc.splitTextToSize(`Activities: ${entry.activities}`, 170);
                    doc.text(activitiesText, 25, yPosition);
                    yPosition += activitiesText.length * 4;
                }
                
                // Weather
                if (entry.weather) {
                    doc.text(`Weather: ${entry.weather}`, 25, yPosition);
                    yPosition += 6;
                }
                
                // Notes
                if (entry.notes) {
                    const notesText = doc.splitTextToSize(`Notes: ${entry.notes}`, 170);
                    doc.text(notesText, 25, yPosition);
                    yPosition += notesText.length * 4;
                }
                
                yPosition += 8; // Space between entries
            });
            
            // Save the PDF - different approach for mobile vs web
            const fileName = `chronicompanion-report-${new Date().toISOString().split('T')[0]}.pdf`;
            
            // Check if we're on mobile (Capacitor)
            const isMobile = window.Capacitor && window.Capacitor.getPlatform() !== 'web';
            
            if (isMobile) {
                // Mobile: Save to filesystem and open with native PDF viewer
                try {
                    const pdfOutput = doc.output('datauristring');
                    const base64Data = pdfOutput.split(',')[1]; // Remove data:application/pdf;base64, prefix
                    
                    console.log('üì± Mobile PDF: Saving file to filesystem...');
                    
                    // Import Capacitor plugins correctly for Capacitor 6
                    const { Filesystem } = window.Capacitor.Plugins;
                    
                    // Directory enum is available directly from Capacitor
                    const Directory = {
                        Documents: 'DOCUMENTS',
                        Data: 'DATA',
                        Library: 'LIBRARY',
                        Cache: 'CACHE',
                        External: 'EXTERNAL',
                        ExternalStorage: 'EXTERNAL_STORAGE'
                    };
                    
                    console.log('üì± Mobile PDF: Available plugins:', Object.keys(window.Capacitor.Plugins));
                    console.log('üì± Mobile PDF: Directory.Documents value:', Directory.Documents);
                    console.log('üì± Mobile PDF: Filesystem available:', !!Filesystem);
                    
                    // Write file to Documents directory
                    const result = await Filesystem.writeFile({
                        path: fileName,
                        data: base64Data,
                        directory: Directory.Documents
                    });
                    
                    console.log('üì± Mobile PDF: File saved to:', result.uri);
                    
                    // Open the PDF with native viewer
                    const { FileOpener } = window.Capacitor.Plugins;
                    await FileOpener.open({
                        filePath: result.uri,
                        contentType: 'application/pdf'
                    });
                    
                    console.log('‚úÖ Mobile PDF export completed and opened');
                    
                } catch (mobileError) {
                    console.error('‚ùå Mobile PDF export failed:', mobileError);
                    // Fallback to regular save
                    doc.save(fileName);
                    console.log('‚úÖ PDF export completed (fallback)');
                }
            } else {
                // Web: Regular download
                doc.save(fileName);
                console.log('‚úÖ PDF export completed');
            }
            
            } catch (error) {
                console.error('‚ùå PDF export failed:', error);
                alert('Failed to export PDF. Please try again.');
            }
        }

        // ========================================
        // AI HEALTH COACH FUNCTIONALITY
        // ========================================
        
        let aiCoach = null;
        let isAIInitialized = false;
        
        // Initialize AI Coach with proper timing (Premium Feature)
        async function initializeAICoach() {
            if (isAIInitialized) {
                updateAIUsageDisplay();
                return;
            }
            
            console.log('ü§ñ Initializing AI Coach...');
            
            // üîí CRITICAL FIX: Wait for authentication to be fully ready BEFORE premium check
            console.log('‚è≥ Ensuring authentication system is ready...');
            if (!window.workingAuth) {
                console.log('‚ö†Ô∏è WorkingAuth not ready, waiting...');
                let authSystemAttempts = 0;
                while (!window.workingAuth && authSystemAttempts < 20) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    authSystemAttempts++;
                }
                
                if (!window.workingAuth) {
                    console.error('‚ùå Authentication system not ready after 10 seconds');
                    showAIPremiumGate(); // Show premium gate as fallback for security
                    return;
                }
            }
            
            // üîí IMPROVED MOBILE FIX: Check authentication status through working auth system
            console.log('üîç Checking authentication status...');
            const isMobile = window.Capacitor && window.Capacitor.getPlatform() !== 'web';
            console.log(`üì± Platform: ${isMobile ? 'Mobile' : 'Web'}`);
            
            // First, try to get session directly (faster approach)
            let userSession = null;
            try {
                const { data: { session }, error } = await window.supabase.auth.getSession();
                if (!error && session?.user) {
                    console.log('‚úÖ Direct session found for user:', session.user.email);
                    userSession = session;
                } else {
                    console.log('üîÑ No direct session, checking working auth...');
                    
                    // Check if working auth has a current user
                    if (window.workingAuth && window.workingAuth.currentUser) {
                        console.log('‚úÖ Working auth has current user:', window.workingAuth.currentUser.email);
                        // Try to get session again after a short wait
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        const { data: { session: retrySession } } = await window.supabase.auth.getSession();
                        if (retrySession?.user) {
                            userSession = retrySession;
                            console.log('‚úÖ Session retrieved after working auth check');
                        }
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Session check error:', error);
            }
            
            // If still no session, but user might be authenticated, show a more user-friendly message
            if (!userSession) {
                console.log('‚ö†Ô∏è No session found - checking if user needs to sign in');
                
                // Check if the user is actually signed out vs. just having session issues
                if (!window.workingAuth || !window.workingAuth.currentUser) {
                    console.log('üîí User not authenticated - showing premium gate');
                    showAIPremiumGate();
                    return;
                } else {
                    // User appears authenticated but session is having issues - try once more with longer wait
                    console.log('üîÑ User appears authenticated but session unavailable, trying extended wait...');
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                    const { data: { finalSession } } = await window.supabase.auth.getSession();
                    if (finalSession?.user) {
                        userSession = finalSession;
                        console.log('‚úÖ Session retrieved after extended wait');
                    } else {
                        console.log('‚ö†Ô∏è Session still unavailable - showing premium gate as fallback');
                        showAIPremiumGate();
                        return;
                    }
                }
            }
            
            // Check if user has premium subscription
            console.log('üîç Checking premium status...');
            console.log('üîç DEBUG: About to call checkPremiumStatus()');
            const isPremium = await checkPremiumStatus();
            console.log('üîç DEBUG: checkPremiumStatus() returned:', isPremium, typeof isPremium);
            
            // üîí IMPROVED MOBILE FIX: Handle premium status more gracefully
            if (!isPremium) {
                if (isMobile) {
                    console.log('üîí Mobile: User is not premium - showing premium gate');
                } else {
                    console.log('üîí Web: User is not premium - showing premium gate');
                }
                showAIPremiumGate();
                return;
            }
            
            console.log('‚úÖ Premium user verified, proceeding with AI Coach initialization...');
            
            try {
                console.log('üöÄ Starting AI Coach backend initialization...');
                
                // SECURE BACKEND: Try Railway first, fallback to localhost if needed
                aiCoach = new window.AIHealthCoachSecure();
                
                // Try Railway backend first
                let success = await aiCoach.initialize({ 
                    backendUrl: 'https://chronicompanion-mobile-production.up.railway.app',
                    dailyLimit: 5  // Free tier limit
                });
                
                // If Railway fails, try localhost backend for development
                if (!success && window.location.hostname === 'localhost') {
                    console.log('üîÑ Railway backend unavailable, trying localhost...');
                    success = await aiCoach.initialize({ 
                        backendUrl: 'http://localhost:3000',
                        dailyLimit: 5  // Free tier limit
                    });
                }
                
                if (success) {
                    displayAIWelcomeMessage();
                    // Load previous AI conversations
                    await loadAIConversations();
                    console.log('‚úÖ AI Coach fully initialized and ready');
                    
                    // Set up event handlers
                    setupAIEventHandlers();
                    
                    // CRITICAL FIX: Only set flag when AI Coach actually succeeds
                    isAIInitialized = true;
                } else {
                    displayAISetupMessage();
                    console.log('‚ö†Ô∏è AI Coach initialization failed - setup required');
                    
                    // Set up event handlers for setup message
                    setupAIEventHandlers();
                    
                    // CRITICAL FIX: Don't set isAIInitialized when setup fails
                    // This allows retries when user clicks the tab again
                }
            } catch (error) {
                console.error('‚ùå AI Coach initialization error:', error);
                displayAIError('Failed to initialize AI Coach: ' + error.message);
            }
        }
        
        // Display welcome message when AI is ready
        function displayAIWelcomeMessage() {
            const chatContainer = document.getElementById('ai-chat-messages');
            chatContainer.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <div class="text-2xl">ü§ñ</div>
                        <div>
                            <h4 class="font-semibold text-green-800 mb-2">Chroni is Ready!</h4>
                            <p class="text-green-700 text-sm mb-2">Your AI health coach is now active and ready to help you understand your health patterns!</p>
                            <p class="text-xs text-green-600">Ask me anything about your symptoms, mood, or health trends.</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Hide welcome message
            document.getElementById('ai-welcome-message').style.display = 'none';
            
            // Update usage display
            updateAIUsageDisplay();
        }

        // Display setup message when API key is needed
        function displayAISetupMessage() {
            const chatContainer = document.getElementById('ai-chat-messages');
            chatContainer.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <div class="text-2xl">üîß</div>
                        <div>
                            <h4 class="font-semibold text-blue-800 mb-2">AI Coach Setup Required</h4>
                            <p class="text-blue-700 text-sm mb-3">To activate your AI health coach, you'll need to add your OpenAI API key.</p>
                            <div class="bg-blue-100 rounded p-2 text-xs font-mono text-blue-800 mb-2">
                                Add your API key to the configuration
                            </div>
                            <p class="text-xs text-blue-600">Get your API key at <a href="https://platform.openai.com/api-keys" target="_blank" class="underline">platform.openai.com</a></p>
                        </div>
                    </div>
                </div>
            `;
            
            // Hide welcome message
            document.getElementById('ai-welcome-message').style.display = 'none';
            
            // Update usage display
            document.getElementById('ai-usage-display').innerHTML = 
                '<span class="text-orange-600">‚öôÔ∏è Setup Required</span>';
        }
        
        // Set up AI event handlers
        function setupAIEventHandlers() {
            // Ask button
            const askBtn = document.getElementById('ai-ask-btn');
            const questionInput = document.getElementById('ai-question-input');
            
            // Remove existing event listeners to prevent duplicates
            askBtn.replaceWith(askBtn.cloneNode(true));
            const newAskBtn = document.getElementById('ai-ask-btn');
            newAskBtn.addEventListener('click', handleAIQuestion);
            
            // Enter key support - also remove existing listeners
            questionInput.replaceWith(questionInput.cloneNode(true));
            const newQuestionInput = document.getElementById('ai-question-input');
            newQuestionInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleAIQuestion();
                }
            });
            
            // Mobile keyboard handling - scroll input into view when focused
            newQuestionInput.addEventListener('focus', () => {
                // Check if we're on mobile
                const isMobile = window.Capacitor && window.Capacitor.getPlatform() !== 'web';
                if (isMobile) {
                    // Delay to allow keyboard to appear
                    setTimeout(() => {
                        // Scroll the input container into view
                        const inputContainer = document.getElementById('ai-input-container');
                        inputContainer.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    }, 300); // Wait 300ms for keyboard animation
                }
            });
            
            // Additional mobile optimization - adjust chat container when keyboard shows
            if (window.Capacitor && window.Capacitor.getPlatform() !== 'web') {
                // Listen for viewport changes (keyboard show/hide)
                window.addEventListener('resize', () => {
                    const chatContainer = document.getElementById('ai-chat-container');
                    const inputContainer = document.getElementById('ai-input-container');
                    
                    // If input is focused, ensure it stays visible
                    if (document.activeElement === questionInput) {
                        setTimeout(() => {
                            inputContainer.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'center' 
                            });
                        }, 100);
                    }
                });
            }
            
            // Quick question buttons
            document.querySelectorAll('.ai-quick-question').forEach(btn => {
                btn.addEventListener('click', () => {
                    const question = btn.dataset.question;
                    document.getElementById('ai-question-input').value = question;
                    handleAIQuestion();
                });
            });
        }
        
        // Handle AI question
        async function handleAIQuestion() {
            const questionInput = document.getElementById('ai-question-input');
            const question = questionInput.value.trim();
            
            if (!question) return;
            
            // Premium check is now handled by the AI Coach script itself
            
            // Show user message
            addAIMessage(question, 'user');
            questionInput.value = '';
            
            // Show thinking indicator
            const thinkingId = addAIMessage('ü§î Analyzing your health data...', 'ai', true);
            
            try {
                if (!aiCoach || !aiCoach.isInitialized) {
                    throw new Error('AI Coach not initialized');
                }
                
                // Get recent health entries for context (from localStorage for now)
                const recentEntries = JSON.parse(localStorage.getItem('chronicompanion_entries') || '[]').slice(0, 7);
                
                // Get AI insight
                const result = await aiCoach.getHealthInsight(question, {
                    recentEntries: recentEntries || []
                });
                
                // Remove thinking indicator
                removeAIMessage(thinkingId);
                
                if (result.success) {
                    // Add AI response
                    addAIMessage(result.insight, 'ai');
                    
                    // Save conversation to database
                    await saveAIConversation(question, result.insight);
                    
                    // Update usage display
                    document.getElementById('ai-usage-display').innerHTML = 
                        `<span class="text-green-600">${result.usage}/${result.limit} questions today</span>`;
                    
                    // Show premium prompt if limit reached
                    if (result.usage >= result.limit) {
                        document.getElementById('ai-premium-prompt').style.display = 'block';
                    }
                } else {
                    // Handle errors (like daily limit reached)
                    addAIMessage(result.error, 'ai');
                    
                    // Show premium prompt for limit errors
                    if (result.error.includes('daily limit') || result.error.includes('Daily AI limit')) {
                        document.getElementById('ai-premium-prompt').style.display = 'block';
                    }
                }
                
            } catch (error) {
                removeAIMessage(thinkingId);
                
                // Handle premium required error specifically
                if (error.message === 'PREMIUM_REQUIRED') {
                    console.log('üîí Premium required error caught - showing premium gate');
                    showAIPremiumGate();
                    return;
                }
                
                addAIMessage('Sorry, I encountered an error. Please try again later. ü§ñüíî', 'ai');
                console.error('‚ùå AI Question Error:', error);
            }
        }
        
        // Add message to AI chat
        function addAIMessage(message, sender, isTemporary = false) {
            const chatMessages = document.getElementById('ai-chat-messages');
            const messageId = 'msg-' + Date.now();
            
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubbleClass = sender === 'user' 
                ? 'bg-purple-600 text-white' 
                : 'bg-gray-200 text-gray-800';
            
            messageDiv.innerHTML = `
                <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${bubbleClass}">
                    ${sender === 'ai' ? '<i class="fas fa-robot mr-2"></i>' : ''}
                    ${message}
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            const chatContainer = document.getElementById('ai-chat-container');
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Hide welcome message on first interaction
            if (chatMessages.children.length === 1) {
                document.getElementById('ai-welcome-message').style.display = 'none';
            }
            
            return messageId;
        }
        
        // Remove AI message (for temporary messages)
        function removeAIMessage(messageId) {
            const message = document.getElementById(messageId);
            if (message) {
                message.remove();
            }
        }
        
        // Save AI conversation to database
        async function saveAIConversation(question, response) {
            try {
                const { data, error } = await window.supabase
                    .from('ai_conversations')
                    .insert([
                        {
                            user_id: window.currentUser?.id,
                            question: question,
                            response: response,
                            created_at: new Date().toISOString()
                        }
                    ]);
                    
                if (error) {
                    console.error('‚ùå Error saving AI conversation:', error);
                } else {
                    console.log('‚úÖ AI conversation saved to database');
                }
            } catch (error) {
                console.error('‚ùå Error saving AI conversation:', error);
            }
        }
        
        // Load AI conversations from database
        async function loadAIConversations() {
            try {
                const { data, error } = await window.supabase
                    .from('ai_conversations')
                    .select('*')
                    .eq('user_id', window.currentUser?.id)
                    .order('created_at', { ascending: true })
                    .limit(20); // Load last 20 conversations
                    
                if (error) {
                    console.error('‚ùå Error loading AI conversations:', error);
                    return;
                }
                
                // Clear existing messages
                document.getElementById('ai-chat-messages').innerHTML = '';
                
                // Add each conversation
                if (data && data.length > 0) {
                    data.forEach(conversation => {
                        addAIMessage(conversation.question, 'user');
                        addAIMessage(conversation.response, 'ai');
                    });
                    console.log(`‚úÖ Loaded ${data.length} AI conversations from database`);
                }
            } catch (error) {
                console.error('‚ùå Error loading AI conversations:', error);
            }
        }
        
        // Update AI usage display
        async function updateAIUsageDisplay() {
            if (!aiCoach || !aiCoach.isInitialized) {
                document.getElementById('ai-usage-display').innerHTML = 
                    '<span class="text-orange-600">‚öôÔ∏è Setup Required</span>';
                return;
            }
            
            try {
                const usage = await aiCoach.getTodayUsage();
                const limit = aiCoach.dailyLimit;
                
                if (usage >= limit) {
                    document.getElementById('ai-usage-display').innerHTML = 
                        `<span class="text-red-600">‚ö†Ô∏è ${usage}/${limit} - Limit Reached</span>`;
                } else {
                    document.getElementById('ai-usage-display').innerHTML = 
                        `<span class="text-green-600">‚úÖ ${usage}/${limit} questions today</span>`;
                }
            } catch (error) {
                console.error('Error updating usage display:', error);
                document.getElementById('ai-usage-display').innerHTML = 
                    '<span class="text-gray-600">Usage: Unknown</span>';
            }
        }
        
        // Display AI error
        function displayAIError(errorMessage) {
            addAIMessage(`‚ùå Error: ${errorMessage}`, 'ai');
        }
        
        // ===============================
        // PREMIUM SUBSCRIPTION FUNCTIONS
        // ===============================
        
        // Check if current user has active premium subscription
        async function checkPremiumStatus() {
            try {
                console.log('üîç checkPremiumStatus: Starting premium check...');
                console.log('üîç DEBUG: window.supabase exists:', !!window.supabase);
                console.log('üîç DEBUG: window.supabase.auth exists:', !!(window.supabase && window.supabase.auth));
                
                // üîí MOBILE FIX: Add extra safety checks for mobile
                const isMobile = window.Capacitor && window.Capacitor.getPlatform() !== 'web';
                if (isMobile) {
                    console.log('üì± checkPremiumStatus: Running mobile-specific premium check');
                    
                    // Extra validation for mobile authentication
                    if (!window.supabase || !window.supabase.auth) {
                        console.warn('üîí Mobile: Supabase not properly initialized for premium check');
                        return false;
                    }
                }
                
                const user = await window.supabase.auth.getUser();
                console.log('üîç DEBUG: getUser() result:', user);
                console.log('üîç DEBUG: user.data:', user.data);
                console.log('üîç DEBUG: user.data.user:', user.data.user);
                if (!user.data.user) {
                    console.log('üîí checkPremiumStatus: No authenticated user for premium check');
                    if (isMobile) {
                        console.log('üì± Mobile: Returning false due to missing user authentication');
                    }
                    return false;
                }
                
                console.log('üîç checkPremiumStatus: User found:', user.data.user.email);
                console.log('üîç checkPremiumStatus: Querying user_subscriptions table...');
                
                const { data: subscription, error } = await window.supabase
                    .from('user_subscriptions')
                    .select('*')
                    .eq('user_id', user.data.user.id)
                    .eq('status', 'active')
                    .single();
                    
                console.log('üîç checkPremiumStatus: Subscription query result:', { subscription, error });
                    
                if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
                    console.error('‚ùå Error checking premium status:', error);
                    return false;
                }
                
                const isPremium = !!subscription;
                console.log('üíé Premium status:', isPremium ? 'ACTIVE' : 'FREE');
                console.log('üîç checkPremiumStatus: Final result:', isPremium);
                
                // Update UI based on premium status
                updatePremiumUI(isPremium);
                
                return isPremium;
            } catch (error) {
                console.error('‚ùå Exception checking premium status:', error);
                return false;
            }
        }
        
        // Update UI elements based on premium status
        function updatePremiumUI(isPremium) {
            // Update AI Coach tab with premium indicator
            const aiTab = document.getElementById('tab-ai-coach');
            if (aiTab) {
                if (isPremium) {
                    aiTab.innerHTML = '<i class="fas fa-robot mr-2"></i>AI Coach <span class="text-yellow-300">üíé</span>';
                } else {
                    aiTab.innerHTML = '<i class="fas fa-robot mr-2"></i>AI Coach <span class="text-gray-400">(Premium)</span>';
                }
            }
            
            // Show/hide premium prompts
            const premiumPrompts = document.querySelectorAll('.premium-prompt');
            premiumPrompts.forEach(prompt => {
                prompt.style.display = isPremium ? 'none' : 'block';
            });
        }
        
        // Show premium upgrade modal
        function showPremiumUpgradeModal() {
            const modal = document.createElement('div');
            modal.id = 'premium-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                    <div class="text-center">
                        <div class="text-4xl mb-4">üíé</div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Upgrade to Premium</h2>
                        <p class="text-gray-600 mb-6">Unlock unlimited AI health insights, advanced analytics, and more!</p>
                        
                        <div class="bg-purple-50 rounded-lg p-4 mb-6">
                            <div class="text-lg font-semibold text-purple-800 mb-2">Premium Features:</div>
                            <ul class="text-left text-purple-700 space-y-1">
                                <li>‚úÖ Unlimited AI Health Coach</li>
                                <li>‚úÖ Advanced Health Analytics</li>
                                <li>‚úÖ Premium PDF Reports</li>
                                <li>‚úÖ Priority Support</li>
                            </ul>
                        </div>
                        
                        <div class="text-center mb-4">
                            <div class="text-2xl font-bold text-purple-600">$4.99/month</div>
                            <div class="text-sm text-gray-500">Cancel anytime</div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="closePremiumModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                                Maybe Later
                            </button>
                            <button onclick="initiatePremiumUpgrade()" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                Upgrade Now
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Close premium upgrade modal
        function closePremiumModal() {
            const modal = document.getElementById('premium-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Initialize Stripe
        const stripe = Stripe('pk_live_51RtomSAHalEGquRxSfIceSJLQ9OSl0608i2nvwdssOXpPwUrw2Xl2jsk6dG1xwywk6WbJN76ecsug1l9PLwlYsjH00rW8QnTec');
        
        // Initiate premium upgrade process
        async function initiatePremiumUpgrade() {
            closePremiumModal();
            
            try {
                // Show loading state
                const loadingDiv = document.createElement('div');
                loadingDiv.innerHTML = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white p-6 rounded-lg">
                            <div class="text-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-4"></div>
                                <p>Setting up your premium subscription...</p>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(loadingDiv);
                
                // Get current user
                const { data: { user } } = await window.supabase.auth.getUser();
                if (!user) {
                    throw new Error('Please sign in to upgrade to premium');
                }
                
                // Create Stripe Checkout session
                const response = await fetch('https://chronicompanion-mobile-production.up.railway.app/api/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${(await window.supabase.auth.getSession()).data.session?.access_token}`
                    },
                    body: JSON.stringify({
                        user_id: user.id,
                        user_email: user.email,
                        success_url: window.location.origin + '?premium=success',
                        cancel_url: window.location.origin + '?premium=cancelled'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to create checkout session');
                }
                
                const { sessionId } = await response.json();
                
                // Redirect to Stripe Checkout
                const { error } = await stripe.redirectToCheckout({
                    sessionId: sessionId
                });
                
                if (error) {
                    throw error;
                }
                
            } catch (error) {
                console.error('‚ùå Premium upgrade error:', error);
                
                // Remove loading state
                const loadingDiv = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
                
                // Show error message
                alert('‚ùå Premium upgrade failed: ' + error.message + '\n\nPlease try again or contact support.');
            }
        }
        
        // SECURITY FIX: addTestPremiumSubscription function removed
        // This function was a critical security vulnerability allowing free premium access
        // Premium subscriptions must only be created through legitimate payment processing
        
        // Show Premium Settings Modal
        function showPremiumSettings() {
            const modal = document.createElement('div');
            modal.id = 'premium-settings-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-96 overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                            üíé Premium Settings
                        </h2>
                        <button onclick="closePremiumSettings()" class="text-gray-500 hover:text-gray-700 text-xl">
                            ‚úï
                        </button>
                    </div>
                    
                    <!-- Subscription Management -->
                    <div class="mb-6 p-4 bg-green-50 rounded-lg">
                        <h3 class="font-semibold text-green-800 mb-2">‚úÖ Active Premium Subscription</h3>
                        <p class="text-green-700 text-sm mb-3">$4.99/month ‚Ä¢ Unlimited AI features</p>
                        <button onclick="cancelSubscription()" 
                                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm font-medium transition-colors">
                            Cancel Subscription
                        </button>
                        <p class="text-xs text-gray-500 mt-2">You'll retain access until your next billing date</p>
                    </div>
                    
                    <!-- Mailing List Signup -->
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <h3 class="font-semibold text-blue-800 mb-2">üìß Stay Updated</h3>
                        <p class="text-blue-700 text-sm mb-3">Get health tips, app updates, and exclusive content!</p>
                        <div class="flex space-x-2">
                            <input type="email" id="mailing-list-email" placeholder="your@email.com" 
                                   class="flex-1 px-3 py-2 border border-blue-300 rounded text-sm">
                            <button onclick="joinMailingList()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium transition-colors">
                                Join List
                            </button>
                        </div>
                    </div>
                    
                    <!-- Feedback Form -->
                    <div class="mb-4 p-4 bg-purple-50 rounded-lg">
                        <h3 class="font-semibold text-purple-800 mb-2">üí¨ Comments & Questions</h3>
                        <p class="text-purple-700 text-sm mb-3">We'd love to hear your feedback!</p>
                        <textarea id="feedback-text" placeholder="Share your thoughts, suggestions, or questions..." 
                                  class="w-full px-3 py-2 border border-purple-300 rounded text-sm mb-2" rows="3"></textarea>
                        <button onclick="submitFeedback()" 
                                class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded text-sm font-medium transition-colors">
                            Send Feedback
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Close Premium Settings Modal
        function closePremiumSettings() {
            const modal = document.getElementById('premium-settings-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Cancel Subscription
        async function cancelSubscription() {
            if (!confirm('Are you sure you want to cancel your premium subscription? You\'ll lose access to AI features at the end of your current billing period.')) {
                return;
            }
            
            try {
                // In a real implementation, you'd call Stripe API to cancel
                // For now, we'll just show a message and update the database
                const { data: { user } } = await window.supabase.auth.getUser();
                if (user) {
                    const { error } = await window.supabase
                        .from('user_subscriptions')
                        .update({ status: 'cancelled' })
                        .eq('user_id', user.id);
                    
                    if (error) {
                        throw error;
                    }
                    
                    alert('‚úÖ Subscription cancelled successfully. You\'ll retain premium access until your next billing date.');
                    closePremiumSettings();
                    
                    // Refresh premium status
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            } catch (error) {
                console.error('‚ùå Cancellation error:', error);
                alert('‚ùå Failed to cancel subscription. Please contact support or manage your subscription through Stripe.');
            }
        }
        
        // Join Mailing List
        async function joinMailingList() {
            const email = document.getElementById('mailing-list-email').value.trim();
            if (!email) {
                alert('Please enter your email address');
                return;
            }
            
            if (!email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }
            
            try {
                // Store in a simple table for now - you could integrate with Mailchimp, ConvertKit, etc.
                const { error } = await window.supabase
                    .from('mailing_list')
                    .insert([{ 
                        email: email, 
                        subscribed_at: new Date().toISOString(),
                        source: 'premium_settings'
                    }]);
                
                if (error && error.code !== '23505') { // 23505 = unique violation (already subscribed)
                    throw error;
                }
                
                document.getElementById('mailing-list-email').value = '';
                alert('‚úÖ Thank you! You\'ve been added to our mailing list.');
            } catch (error) {
                console.error('‚ùå Mailing list error:', error);
                alert('‚úÖ Thank you for signing up! (Note: Mailing list table needs to be created in Supabase)');
            }
        }
        
        // Submit Feedback
        async function submitFeedback() {
            const feedback = document.getElementById('feedback-text').value.trim();
            if (!feedback) {
                alert('Please enter your feedback');
                return;
            }
            
            try {
                const { data: { user } } = await window.supabase.auth.getUser();
                
                // Store feedback in database
                const { error } = await window.supabase
                    .from('user_feedback')
                    .insert([{
                        user_id: user?.id,
                        feedback: feedback,
                        submitted_at: new Date().toISOString(),
                        source: 'premium_settings'
                    }]);
                
                if (error) {
                    throw error;
                }
                
                document.getElementById('feedback-text').value = '';
                alert('‚úÖ Thank you for your feedback! We really appreciate it.');
            } catch (error) {
                console.error('‚ùå Feedback error:', error);
                alert('‚úÖ Thank you for your feedback! (Note: Feedback table needs to be created in Supabase)');
            }
        }
        
        // Initialize premium features on page load
        async function initializePremiumFeatures() {
            console.log('üíé Initializing premium features...');
            
            // Check premium status when user is authenticated
            const { data: { session } } = await window.supabase.auth.getSession();
            if (session?.user) {
                await checkPremiumStatus();
            }
            
            // Listen for auth changes to update premium status
            window.supabase.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session?.user) {
                    await checkPremiumStatus();
                } else if (event === 'SIGNED_OUT') {
                    updatePremiumUI(false);
                }
            });
        }
        
        // Show AI Premium Gate
        function showAIPremiumGate() {
            const aiContent = document.getElementById('content-ai-coach');
            if (aiContent) {
                aiContent.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-6">ü§ñüíé</div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">AI Health Coach</h2>
                        <p class="text-gray-600 mb-6 max-w-md mx-auto">
                            Get personalized health insights, pattern analysis, and coaching recommendations 
                            powered by advanced AI technology.
                        </p>
                        
                        <div class="bg-purple-50 rounded-lg p-6 max-w-md mx-auto mb-8">
                            <h3 class="font-semibold text-purple-800 mb-3">Premium AI Features:</h3>
                            <ul class="text-left text-purple-700 space-y-2">
                                <li>üß† Intelligent health pattern analysis</li>
                                <li>üí° Personalized wellness recommendations</li>
                                <li>üìà Trend identification and insights</li>
                                <li>üéØ Goal setting and progress tracking</li>
                                <li>‚ö° Unlimited AI conversations</li>
                            </ul>
                        </div>
                        
                        <div class="space-y-3">
                            <button onclick="showPremiumUpgradeModal()" 
                                    class="bg-purple-600 hover:bg-purple-700 text-white px-8 py-3 rounded-lg font-semibold transition-colors">
                                Upgrade to Premium - $4.99/month
                            </button>
                            <!-- SECURITY FIX: Test Premium button removed for production security -->
                        </div>
                    </div>
                `;
            }
        }
        
        // Hide AI Premium Gate and restore chat interface
        function hideAIPremiumGate() {
            const aiContent = document.getElementById('content-ai-coach');
            if (aiContent && aiContent.innerHTML.includes('AI Health Coach')) {
                // Reset the AI initialization flag so it can be properly initialized
                isAIInitialized = false;
                
                // Restore original AI chat interface
                aiContent.innerHTML = `
                    <div class="bg-white rounded-lg shadow-md h-full flex flex-col">
                        <div class="p-4 border-b border-gray-200">
                            <h2 class="text-xl font-semibold text-sage-800 flex items-center">
                                <i class="fas fa-robot mr-2 text-purple-600"></i>
                                AI Health Coach üíé
                            </h2>
                            <p class="text-sm text-sage-600 mt-1">Get personalized health insights based on your entries</p>
                            <div id="ai-usage-display" class="text-xs text-gray-500 mt-2">
                                <span class="text-green-600">Premium: Unlimited</span>
                            </div>
                            <div class="mt-2">
                                <button onclick="showPremiumSettings()" class="text-xs text-purple-600 hover:text-purple-800 underline">
                                    ‚öôÔ∏è Premium Settings
                                </button>
                            </div>
                        </div>
                        
                        <div id="ai-chat-container" class="flex-1 overflow-y-auto p-4 min-h-0">
                            <div id="ai-chat-messages" class="space-y-4">
                                <!-- Messages will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="p-4 border-t border-gray-200 relative pb-20 md:pb-4">
                            <div class="flex space-x-2">
                                <input type="text" 
                                       id="ai-question-input"
                                       placeholder="Ask about your health patterns, symptoms, or wellness advice..."
                                       class="flex-1 px-3 py-2 border border-sage-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm">
                                <button id="ai-ask-btn"
                                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Reinitialize AI Coach now that user has premium
                initializeAICoach();
            }
        }
        
        // Handle Stripe success/cancel URLs
        function handleStripeReturn() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.get('premium') === 'success') {
                // Remove URL parameter
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Show success message
                setTimeout(() => {
                    alert('üéâ Welcome to Premium! Your subscription is now active. Refresh the page to access premium features.');
                    // Refresh premium status
                    initializePremiumFeatures();
                }, 1000);
                
            } else if (urlParams.get('premium') === 'cancelled') {
                // Remove URL parameter
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Show cancelled message
                setTimeout(() => {
                    alert('‚ö†Ô∏è Premium upgrade was cancelled. You can try again anytime from the AI Coach tab.');
                }, 500);
            }
        }
        
        // Call initialize premium features after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            handleStripeReturn();
            initializePremiumFeatures();
        });
    </script>
</body>
</html> 